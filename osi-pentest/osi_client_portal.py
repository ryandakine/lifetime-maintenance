#!/usr/bin/env python3
"""OSI Client Portal - Self-Service Client Access"""

import streamlit as st
import json
import os
from datetime import datetime

# Database Files
DB_FILE = "clients.json"

def load_json(path):
    if not os.path.exists(path): return []
    try:
        with open(path, 'r') as f: return json.load(f)
    except: return []

st.set_page_config(page_title="OSI Client Portal", page_icon="ğŸ”", layout="wide")

# Hacker Green Theme
st.markdown("""
<style>
    .stApp {
        background-color: #0a0e0f;
        color: #00ff41;
    }
    
    .stMarkdown, .stText, p, span, div {
        color: #00ff41 !important;
    }
    
    h1, h2, h3, h4, h5, h6 {
        color: #00ff00 !important;
        text-shadow: 0 0 10px #00ff41;
    }
    
    .stButton > button {
        background-color: #003300;
        color: #00ff41 !important;
        border: 2px solid #00ff41;
    }
    
    .metric-box {
        background-color: #1a1f1a;
        padding: 20px;
        border: 2px solid #00ff41;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0, 255, 65, 0.3);
    }
</style>
""", unsafe_allow_html=True)

# Login System
if 'client_logged_in' not in st.session_state:
    st.session_state.client_logged_in = False
    st.session_state.client_data = None

def client_login():
    st.title("ğŸ” OSI Client Portal")
    st.markdown("*Secure access to your account*")
    
    with st.form("client_login"):
        st.subheader("Client Login")
        client_code = st.text_input("Client Access Code", type="password", help="Your unique 6-digit code (contact OSI if you need it)")
        
        if st.form_submit_button("Login", type="primary"):
            clients = load_json(DB_FILE)
            
            # Find client by code (simplified - in production, use hashed codes)
            for client in clients:
                # Generate code from client name (last 6 chars of name + id for now)
                code = f"{client['name'][-3:].upper()}{client['id']:03d}"
                
                if code == client_code.upper():
                    st.session_state.client_logged_in = True
                    st.session_state.client_data = client
                    st.rerun()
                    return
            
            st.error("âŒ Invalid access code. Please contact OSI support.")
    
    st.markdown("---")
    st.info("ğŸ“§ **Need help?** Contact ryan@osi-cyber.com")

def client_dashboard():
    client = st.session_state.client_data
    
    st.title(f"Welcome, {client['name']}! ğŸ‘‹")
    st.markdown(f"*Account ID: {client['id']} | Tier: {client.get('tier', 'N/A')}*")
    
    if st.sidebar.button("ğŸšª Logout"):
        st.session_state.client_logged_in = False
        st.session_state.client_data = None
        st.rerun()
    
    # Account Overview
    st.header("ğŸ“Š Account Overview")
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.markdown('<div class="metric-box">', unsafe_allow_html=True)
        st.metric("Monthly Retainer", f"${client.get('mrr', 0):,}")
        st.markdown('</div>', unsafe_allow_html=True)
    
    with col2:
        st.markdown('<div class="metric-box">', unsafe_allow_html=True)
        hours_used = client.get('hours_used', 0)
        hours_limit = client.get('hours_limit', 0)
        st.metric("Hours Used", f"{hours_used}/{hours_limit}")
        if hours_limit > 0:
            pct = (hours_used / hours_limit) * 100
            if pct > 90:
                st.warning(f"âš ï¸ {pct:.0f}% utilized")
            else:
                st.info(f"âœ… {pct:.0f}% utilized")
        st.markdown('</div>', unsafe_allow_html=True)
    
    with col3:
        st.markdown('<div class="metric-box">', unsafe_allow_html=True)
        joined = client.get('joined', 'N/A')
        st.metric("Member Since", joined)
        st.markdown('</div>', unsafe_allow_html=True)
    
    # Tabs for different sections
    tab1, tab2, tab3 = st.tabs(["ğŸ“„ Invoices", "â±ï¸ Time Tracking", "ğŸ“ Support"])
    
    with tab1:
        st.subheader("ğŸ“„ Your Invoices")
        
        # Check for generated invoices
        invoice_dir = "./generated_documents"
        if os.path.exists(invoice_dir):
            client_invoices = [f for f in os.listdir(invoice_dir) if f.startswith(f"Invoice_{client['name'].replace(' ', '_')}")]
            
            if client_invoices:
                for invoice_file in sorted(client_invoices, reverse=True):
                    with st.expander(f"ğŸ“‘ {invoice_file}"):
                        file_path = os.path.join(invoice_dir, invoice_file)
                        
                        # File info
                        file_size = os.path.getsize(file_path)
                        file_date = datetime.fromtimestamp(os.path.getmtime(file_path))
                        
                        st.write(f"**Date:** {file_date.strftime('%B %d, %Y')}")
                        st.write(f"**Size:** {file_size / 1024:.1f} KB")
                        
                        # Download button
                        with open(file_path, 'rb') as f:
                            st.download_button(
                                "ğŸ“¥ Download PDF",
                                data=f.read(),
                                file_name=invoice_file,
                                mime="application/pdf"
                            )
            else:
                st.info("No invoices available yet.")
        else:
            st.info("No invoices available yet.")
    
    with tab2:
        st.subheader("â±ï¸ Time Tracking")
        
        hours_used = client.get('hours_used', 0)
        hours_limit = client.get('hours_limit', 0)
        hours_remaining = hours_limit - hours_used
        
        st.progress(hours_used / hours_limit if hours_limit > 0 else 0)
        
        col1, col2 = st.columns(2)
        col1.metric("Hours Remaining", f"{hours_remaining:.1f}")
        col2.metric("Estimated Days Left", f"{(hours_remaining / 8):.1f}" if hours_remaining > 0 else "0")
        
        if hours_remaining < 2:
            st.error("âš ï¸ **Low Hours Alert:** You're running low on retainer hours. Contact OSI to add more.")
        
        st.markdown("---")
        st.info("ğŸ’¡ **Need more hours?** We can upgrade your tier or add one-time hour packages.")
    
    with tab3:
        st.subheader("ğŸ“ Contact OSI Support")
        
        st.markdown("""
        **Ryan Brenny**  
        CEO & Founder  
        
        ğŸ“§ Email: ryan@osi-cyber.com  
        ğŸŒ Web: https://osi-cyber.com  
        ğŸ“ Denver, Colorado  
        
        **Hours of Operation:**  
        Monday - Friday: 9 AM - 6 PM MST  
        Emergency Support: 24/7 for Tier 2+ clients
        """)
        
        st.markdown("---")
        st.subheader("ğŸ“¨ Quick Message")
        
        with st.form("support_message"):
            subject = st.text_input("Subject")
            message = st.text_area("Message")
            
            if st.form_submit_button("Send Message"):
                # In production, this would send an email
                st.success("âœ… Message sent! We'll respond within 24 hours.")

# Main App Logic
if not st.session_state.client_logged_in:
    client_login()
else:
    client_dashboard()
