#!/usr/bin/env python3
from fpdf import FPDF
from datetime import datetime
from rich.console import Console
from rich.prompt import Prompt

console = Console()

class OSIReport(FPDF):
    def __init__(self, title, client_name):
        super().__init__()
        self.title_text = title
        self.client_name = client_name
        self.set_auto_page_break(auto=True, margin=15)

    def header(self):
        self.set_font('Helvetica', 'B', 10)
        self.set_text_color(100, 100, 100) # Grey
        self.cell(0, 10, 'ON-SITE INTELLIGENCE // CONFIDENTIAL', 0, 0, 'R')
        self.ln(15)

    def footer(self):
        self.set_y(-15)
        self.set_font('Helvetica', 'I', 8)
        self.set_text_color(128)
        self.cell(0, 10, f'Page {self.page_no()} | OSI Security Operations', 0, 0, 'C')

    def create_cover_page(self):
        self.add_page()
        self.set_fill_color(0, 50, 0) # Dark Green OSI Color
        self.rect(0, 0, 210, 297, 'F') # Full page background
        
        self.set_text_color(255, 255, 255)
        self.ln(80)
        self.set_font('Helvetica', 'B', 36)
        self.multi_cell(0, 15, self.title_text, align='C')
        
        self.ln(20)
        self.set_font('Helvetica', '', 16)
        self.cell(0, 10, f"Prepared for: {self.client_name}", 0, 1, 'C')
        self.cell(0, 10, datetime.now().strftime('%B %d, %Y'), 0, 1, 'C')
        
        self.add_page() # Reset to white page
        self.set_text_color(0, 0, 0)

    def section_title(self, title):
        self.set_font('Helvetica', 'B', 16)
        self.set_text_color(0, 100, 0)
        self.cell(0, 10, title, 0, 1)
        self.ln(2)

    def heading(self, text):
        self.set_font('Helvetica', 'B', 12)
        self.set_text_color(0, 0, 0)
        self.cell(0, 10, text, 0, 1)

    def body_text(self, text):
        self.set_font('Helvetica', '', 11)
        self.multi_cell(0, 5, text)
        self.ln(5)

    def add_risk_finding(self, title, severity, description, remediation):
        self.set_font('Helvetica', 'B', 12)
        
        # Color code severity
        if severity.upper() == "CRITICAL":
            self.set_fill_color(255, 0, 0)
            self.set_text_color(255, 255, 255)
        elif severity.upper() == "HIGH":
            self.set_fill_color(255, 69, 0)
            self.set_text_color(255, 255, 255)
        elif severity.upper() == "MEDIUM":
            self.set_fill_color(255, 165, 0)
            self.set_text_color(0, 0, 0)
        else:
            self.set_fill_color(0, 255, 0)
            self.set_text_color(0, 0, 0)
            
        self.cell(0, 8, f" [{severity}] {title}", 0, 1, 'L', 1)
        self.set_text_color(0, 0, 0)
        
        self.ln(2)
        self.set_font('Helvetica', 'B', 11)
        self.cell(0, 6, "Description:", 0, 1)
        self.set_font('Helvetica', '', 11)
        self.multi_cell(0, 5, description)
        
        self.ln(2)
        self.set_font('Helvetica', 'B', 11)
        self.cell(0, 6, "Remediation:", 0, 1)
        self.set_font('Helvetica', '', 11)
        self.multi_cell(0, 5, remediation)
        self.ln(8)

def report_wizard():
    console.print(Panel("[bold green]OSI REPORT GENERATOR[/bold green]"))
    
    rpt_type = Prompt.ask("Report Type", choices=["PenTest", "Incident", "Compliance"])
    client = Prompt.ask("Client Name")
    
    pdf = OSIReport(f"{rpt_type} Report", client)
    pdf.create_cover_page()
    
    # Executive Summary
    pdf.section_title("1. Executive Summary")
    summary = Prompt.ask("Enter Executive Summary (one line)")
    pdf.body_text(summary)
    
    # Findings Loop
    if rpt_type == "PenTest":
        pdf.section_title("2. Technical Findings")
        while True:
            console.print("[yellow]Add a finding (or 'done')[/yellow]")
            title = Prompt.ask("Finding Title")
            if title.lower() == 'done': break
            
            sev = Prompt.ask("Severity", choices=["Critical", "High", "Medium", "Low"])
            desc = Prompt.ask("Description")
            rem = Prompt.ask("Remediation")
            
            pdf.add_risk_finding(title, sev, desc, rem)
            
    filename = f"OSI_{rpt_type}_{client.replace(' ', '_')}.pdf"
    pdf.output(filename)
    console.print(f"[bold green]Report Generated: {filename}[/bold green]")

if __name__ == "__main__":
    report_wizard()
