#!/usr/bin/env python3
"""OSI Document Template Filler and PDF Generator"""

from docx import Document
from datetime import datetime
import os
import tempfile
from fpdf import FPDF

class OSIDocumentGenerator:
    """Fills Word templates and generates PDFs"""
    
    def __init__(self, template_dir="./templates/business"):
        self.template_dir = template_dir
    
    def fill_invoice(self, client_data, invoice_data):
        """Generate invoice PDF"""
        pdf = FPDF()
        pdf.add_page()
        
        # Header
        pdf.set_font('Helvetica', 'B', 20)
        pdf.cell(0, 15, 'ON-SITE INTELLIGENCE LLC', 0, 1, 'C')
        pdf.set_font('Helvetica', '', 10)
        pdf.cell(0, 5, 'Cybersecurity & AI Automation', 0, 1, 'C')
        pdf.ln(10)
        
        # Invoice Title
        pdf.set_font('Helvetica', 'B', 16)
        pdf.cell(0, 10, 'INVOICE', 0, 1)
        pdf.ln(5)
        
        # Invoice Details
        pdf.set_font('Helvetica', '', 11)
        pdf.cell(100, 7, f"Invoice #: INV-{invoice_data.get('number', datetime.now().strftime('%Y%m%d'))}", 0, 0)
        pdf.cell(0, 7, f"Date: {invoice_data.get('date', datetime.now().strftime('%B %d, %Y'))}", 0, 1)
        pdf.cell(100, 7, f"Due Date: {invoice_data.get('due_date', 'Upon Receipt')}", 0, 1)
        pdf.ln(10)
        
        # Bill To
        pdf.set_font('Helvetica', 'B', 12)
        pdf.cell(0, 7, 'Bill To:', 0, 1)
        pdf.set_font('Helvetica', '', 11)
        pdf.cell(0, 6, client_data.get('name', ''), 0, 1)
        if client_data.get('contact'):
            pdf.cell(0, 6, f"Attn: {client_data['contact']}", 0, 1)
        if client_data.get('email'):
            pdf.cell(0, 6, client_data['email'], 0, 1)
        pdf.ln(10)
        
        # Services Table
        pdf.set_font('Helvetica', 'B', 11)
        pdf.set_fill_color(230, 230, 230)
        pdf.cell(120, 10, 'Description', 1, 0, 'L', True)
        pdf.cell(35, 10, 'Amount', 1, 1, 'R', True)
        
        pdf.set_font('Helvetica', '', 11)
        description = invoice_data.get('description', 'Professional Services')
        amount = invoice_data.get('amount', 0)
        
        pdf.cell(120, 10, description, 1, 0)
        pdf.cell(35, 10, f"${amount:,.2f}", 1, 1, 'R')
        
        # Total
        pdf.ln(5)
        pdf.set_font('Helvetica', 'B', 12)
        pdf.cell(120, 10, 'TOTAL DUE:', 0, 0, 'R')
        pdf.cell(35, 10, f"${amount:,.2f}", 1, 1, 'R')
        
        # Payment Instructions
        pdf.ln(15)
        pdf.set_font('Helvetica', '', 10)
        pdf.multi_cell(0, 5, 
            "Payment Instructions:\n"
            "* Bank Transfer: [Bank Details]\n"
            "* Check: Payable to On-Site Intelligence LLC\n"
            "* Credit Card: Available upon request\n\n"
            "Thank you for your business!"
        )
        
        # Footer
        pdf.set_y(-30)
        pdf.set_font('Helvetica', 'I', 8)
        pdf.cell(0, 5, 'On-Site Intelligence LLC', 0, 1, 'C')
        pdf.cell(0, 5, 'Denver, Colorado | osi-cyber.com', 0, 1, 'C')
        
        return pdf
    
    def fill_nda(self, party1_data, party2_data):
        """Generate NDA PDF"""
        pdf = FPDF()
        pdf.add_page()
        
        # Header
        pdf.set_font('Helvetica', 'B', 16)
        pdf.cell(0, 10, 'NON-DISCLOSURE AGREEMENT', 0, 1, 'C')
        pdf.ln(5)
        
        # Date
        pdf.set_font('Helvetica', '', 11)
        pdf.cell(0, 7, f"Effective Date: {datetime.now().strftime('%B %d, %Y')}", 0, 1)
        pdf.ln(5)
        
        # Parties
        pdf.set_font('Helvetica', 'B', 12)
        pdf.cell(0, 7, 'Between:', 0, 1)
        pdf.set_font('Helvetica', '', 11)
        pdf.cell(0, 6, f"Party 1: {party1_data.get('name', 'On-Site Intelligence LLC')}", 0, 1)
        pdf.cell(0, 6, f"Party 2: {party2_data.get('name', '')}", 0, 1)
        pdf.ln(10)
        
        # Body
        pdf.set_font('Helvetica', '', 10)
        pdf.multi_cell(0, 5,
            "This Non-Disclosure Agreement (\"Agreement\") is entered into to protect confidential "
            "information that may be disclosed during the course of business discussions or engagement.\n\n"
            
            "1. CONFIDENTIAL INFORMATION\n"
            "For purposes of this Agreement, \"Confidential Information\" means any information disclosed "
            "by either party that is marked as confidential or would reasonably be considered confidential.\n\n"
            
            "2. OBLIGATIONS\n"
            "The receiving party agrees to:\n"
            "   a) Hold confidential information in strict confidence\n"
            "   b) Not disclose to third parties without written consent\n"
            "   c) Use confidential information only for authorized purposes\n\n"
            
            "3. TERM\n"
            "This Agreement shall remain in effect for a period of three (3) years from the Effective Date.\n\n"
            
            "4. RETURN OF INFORMATION\n"
            "Upon request, all confidential information and copies shall be returned or destroyed.\n\n"
        )
        
        # Signature blocks
        pdf.ln(20)
        pdf.set_font('Helvetica', 'B', 11)
        pdf.cell(90, 7, 'PARTY 1:', 0, 0)
        pdf.cell(90, 7, 'PARTY 2:', 0, 1)
        pdf.ln(15)
        pdf.set_font('Helvetica', '', 10)
        pdf.cell(90, 7, '_' * 40, 0, 0)
        pdf.cell(90, 7, '_' * 40, 0, 1)
        pdf.cell(90, 5, party1_data.get('name', 'On-Site Intelligence LLC'), 0, 0)
        pdf.cell(90, 5, party2_data.get('name', ''), 0, 1)
        
        return pdf
    
    def fill_sow(self, client_data, project_data):
        """Generate Statement of Work PDF"""
        pdf = FPDF()
        pdf.add_page()
        
        # Header
        pdf.set_font('Helvetica', 'B', 16)
        pdf.cell(0, 10, 'STATEMENT OF WORK', 0, 1, 'C')
        pdf.ln(5)
        
        # Project Info
        pdf.set_font('Helvetica', 'B', 12)
        pdf.cell(0, 7, f"Project: {project_data.get('name', 'Security Engagement')}", 0, 1)
        pdf.set_font('Helvetica', '', 11)
        pdf.cell(0, 6, f"Client: {client_data.get('name', '')}", 0, 1)
        pdf.cell(0, 6, f"Date: {datetime.now().strftime('%B %d, %Y')}", 0, 1)
        pdf.ln(10)
        
        # Scope
        pdf.set_font('Helvetica', 'B', 12)
        pdf.cell(0, 7, '1. SCOPE OF WORK', 0, 1)
        pdf.set_font('Helvetica', '', 10)
        pdf.multi_cell(0, 5, project_data.get('scope', 'To be defined'))
        pdf.ln(5)
        
        # Deliverables
        pdf.set_font('Helvetica', 'B', 12)
        pdf.cell(0, 7, '2. DELIVERABLES', 0, 1)
        pdf.set_font('Helvetica', '', 10)
        deliverables = project_data.get('deliverables', [])
        if isinstance(deliverables, str):
            deliverables = deliverables.split('\n')
        for d in deliverables:
            if d.strip():
                pdf.cell(0, 5, f"  * {d.strip()}", 0, 1)
        pdf.ln(5)
        
        # Timeline
        pdf.set_font('Helvetica', 'B', 12)
        pdf.cell(0, 7, '3. TIMELINE', 0, 1)
        pdf.set_font('Helvetica', '', 10)
        pdf.cell(0, 6, f"Start Date: {project_data.get('start_date', 'TBD')}", 0, 1)
        pdf.cell(0, 6, f"End Date: {project_data.get('end_date', 'TBD')}", 0, 1)
        pdf.cell(0, 6, f"Duration: {project_data.get('duration', 'TBD')}", 0, 1)
        pdf.ln(5)
        
        # Investment
        pdf.set_font('Helvetica', 'B', 12)
        pdf.cell(0, 7, '4. INVESTMENT', 0, 1)
        pdf.set_font('Helvetica', '', 10)
        pdf.cell(0, 6, f"Total: ${project_data.get('amount', 0):,.2f}", 0, 1)
        
        # Signatures
        pdf.ln(20)
        pdf.set_font('Helvetica', 'B', 11)
        pdf.cell(90, 7, 'CLIENT:', 0, 0)
        pdf.cell(90, 7, 'OSI:', 0, 1)
        pdf.ln(15)
        pdf.set_font('Helvetica', '', 10)
        pdf.cell(90, 7, '_' * 40, 0, 0)
        pdf.cell(90, 7, '_' * 40, 0, 1)
        
        return pdf
    
    def save_pdf(self, pdf, filename):
        """Save PDF to file and return path"""
        output_dir = "./generated_documents"
        os.makedirs(output_dir, exist_ok=True)
        filepath = os.path.join(output_dir, filename)
        pdf.output(filepath)
        return filepath
