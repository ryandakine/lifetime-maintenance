#!/usr/bin/env python3
import sys
import os
import time
from rich.console import Console
from rich.panel import Panel
from rich.layout import Layout
from rich import print

console = Console()

def clear_screen():
    os.system('cls' if os.name == 'nt' else 'clear')

def show_splash():
    clear_screen()
    splash = """
[bold green]
   ___  ____ ___  ____     _______   ______  _____  ____  
  / _ \/ ___|_ _|/ ___|   / ___/ /  /  _/  |/  /  |/  /  
 / // /\__ \ | || |       / /__/ /___/ // /|_/ / /|_/ /   
 \___/ ____/___|\____/    \___/____/___/_/  /_/_/  /_/    
[/bold green]
[dim]ON-SITE INTELLIGENCE // UNIFIED COMMAND CONSOLE v2.0[/dim]
"""
    console.print(splash, justify="center")

def main_menu():
    show_splash()
    
    menu_text = """
[bold white]SELECT MODULE:[/bold white]

[1] [cyan]OSI SCOUT[/cyan]       - Offensive Security & 5G Audit
[2] [cyan]OSI SENTINEL[/cyan]    - Passive Network Monitoring (Active)
[3] [cyan]OSI VISION[/cyan]      - AI Camera Surveillance & Search
[4] [cyan]OSI CORTEX[/cyan]      - Private LLM Interface
[5] [cyan]OSI MEMORY[/cyan]      - Ingest Documents for RAG
[6] [cyan]OSI INDUSTRY[/cyan]    - Predictive Maintenance (SIMCO)
[7] [cyan]OSI MESH[/cyan]        - Distributed AI Controller
[8] [cyan]OSI OPS[/cyan]         - Business Dashboard (GUI)
[9] [cyan]OSI AGENT[/cyan]       - Build Rust Field Agent
[10] [cyan]OSI DOJO[/cyan]      - Rust Training Module
[Q] Quit
    """
    console.print(Panel(menu_text, border_style="green", title="MAIN MENU", width=60))
    
    choice = console.input("[bold green]OSI > [/bold green]").strip().upper()
    return choice

def run_dojo():
    console.print("\n[bold cyan]ENTERING THE DOJO...[/bold cyan]")
    # Build release if not exists for speed, but for now we use debug from prev step or cargo run
    cmd = "cd osi-dojo && cargo run" # cargo run handles build if needed
    os.system(cmd)
    input("\nPress Enter to return...")

def run_agent_build():
    console.print("\n[bold cyan]BUILDING RUST FIELD AGENT...[/bold cyan]")
    cmd = "cd osi-agent && cargo build --release"
    os.system(cmd)
    
    if os.path.exists("osi-agent/target/release/osi-agent"):
        console.print("[green]SUCCESS: Agent Built.[/green]")
        console.print(f"Binary at: {os.path.abspath('osi-agent/target/release/osi-agent')}")
    else:
        console.print("[red]Build Failed.[/red]")
    input("\nPress Enter to return...")

def run_ops():
    console.print("[green]Launching Operations Center in Browser...[/green]")
    cmd = "./venv/bin/streamlit run osi_ops.py > /dev/null 2>&1 &"
    os.system(cmd)
    time.sleep(2) # Give it time to spawn
    input("\nPress Enter to return (Ops Center running in background)...")

def run_industrial():
    cmd = "./venv/bin/python osi_industrial.py"
    os.system(cmd)
    input("\nPress Enter to return...")

def run_mesh():
    cmd = "./venv/bin/python osi_mesh.py"
    os.system(cmd)
    input("\nPress Enter to return...")

def run_ingest():
    console.print("\n[bold cyan]OSI CORPORATE MEMORY INGESTION[/bold cyan]")
    path = input("Enter Path to Documents (PDF/Docx/Txt): ").strip()
    if not os.path.exists(path):
        console.print("[red]Path does not exist.[/red]")
        return
        
    cmd = f"./venv/bin/python osi_rag.py '{path}'"
    os.system(cmd)
    input("\nPress Enter to return...")

def run_scout():
    console.print("\n[bold cyan]Launch Scout?[/bold cyan] (Enter Target IP/Domain): ", end="")
    target = input()
    if not target: return
    
    # Check for mode
    console.print("[dim]Select Mode: [1] Full Scan [2] 5G Audit [3] Web Only[/dim]")
    mode_sel = input("Mode [1]: ").strip()
    mode = "full"
    if mode_sel == "2": mode = "5g"
    elif mode_sel == "3": mode = "web"
    
    cmd = f"python3 osi_scanner.py {target} --mode {mode}"
    os.system(cmd)
    input("\nPress Enter to return...")

def run_vision():
    console.print("\n[bold cyan]OSI VISION[/bold cyan]")
    console.print("[1] Sentinel Mode (Live Record)")
    console.print("[2] Search Memory")
    sel = input("Select [1]: ").strip()
    
    if sel == '2':
        query = input("Enter search query (e.g. 'Person in red'): ")
        cmd = f"./venv/bin/python osi_vision.py --mode search --query '{query}'"
    else:
        # Default source 0
        src = input("Camera Source [0]: ").strip() or "0"
        cmd = f"./venv/bin/python osi_vision.py --mode record --source {src}"
    
    os.system(cmd)
    input("\nPress Enter to return...")

def run_cortex():
    console.print("\n[bold cyan]OSI CORTEX[/bold cyan]")
    console.print("Launching Neural Interface...")
    # Run streamlit
    cmd = "streamlit run osi_cortex.py"
    # Streamlit blocks, so we run it directly
    os.system(cmd)

def run_sentinel():
    console.print("\n[bold cyan]OSI SENTINEL[/bold cyan]")
    iface = input("Network Interface [eth0]: ").strip() or "eth0"
    
    console.print("[yellow]Note: Sentinel requires SUDO privileges for packet capture.[/yellow]")
    # We use sudo ./venv/bin/python to maintain access to libraries
    cmd = f"sudo ./venv/bin/python osi_sentinel.py --iface {iface}"
    os.system(cmd)
    input("\nPress Enter to return...")

def main():
    while True:
        choice = main_menu()
        
        if choice == '1':
            run_scout()
        elif choice == '2':
            run_sentinel()
        elif choice == '3':
            run_vision()
        elif choice == '4':
            run_cortex()
        elif choice == '5':
            run_ingest()
        elif choice == '6':
            run_industrial()
        elif choice == '7':
            run_mesh()
        elif choice == '8':
            run_ops()
        elif choice == '9':
            run_agent_build()
        elif choice == '10':
            run_dojo()
        elif choice == 'Q':
            console.print("[green]Shutting down systems...[/green]")
            break
        else:
            console.print("[red]Invalid command.[/red]")
            time.sleep(1)

if __name__ == "__main__":
    main()
