#!/usr/bin/env python3
import os
import time
import subprocess
from rich.console import Console
from rich.panel import Panel
from rich.prompt import Prompt
from rich.markdown import Markdown
from rich.syntax import Syntax

console = Console()

def clear():
    os.system('cls' if os.name == 'nt' else 'clear')

def show_step(title, content, command=None):
    clear()
    console.print(Panel(f"[bold green]{title}[/bold green]", border_style="green"))
    console.print(Markdown(content))
    
    if command:
        console.print(f"\n[bold cyan]Command to run:[/bold cyan]")
        console.print(Panel(f"[bold white]{command}[/bold white]", border_style="cyan"))
        
        if Prompt.ask("\n[yellow]Do you want to run this command now?[/yellow] (y/n)", default="y") == "y":
            console.print("\n[bold]Output:[/bold]")
            os.system(command)
            Prompt.ask("\n[dim]Press Enter to continue...[/dim]")
        else:
            console.print("[dim]Skipping execution...[/dim]")
            time.sleep(1)

def run_netcat_demo():
    clear()
    console.print(Panel("[bold red]Netcat: The Hacker's Swiss Army Knife[/bold red]", border_style="red"))
    console.print(Markdown("""
Netcat (`nc`) is a versatile tool for reading from and writing to network connections.

**Key Uses:**
1.  **Chat/Data Transfer**: Connect two computers.
2.  **Port Scanning**: Check for open ports.
3.  **Bind Shells**: Execute commands remotely (Dangerous!).

**Interactive Demo:**
Since Netcat listeners block the terminal, we can't run them easily inside this script.
You need to open **TWO** terminal windows for this.
    """))
    
    steps = [
        ("1. Start a Listener", "nc -lvp 4444", "Open Terminal 2 and run this to start listening on port 4444."),
        ("2. Connect as Client", "nc 127.0.0.1 4444", "In THIS terminal (or a 3rd one), run this to connect to the listener."),
        ("3. Port Scan", "nc -zvn 127.0.0.1 1-1000", "Scan local ports 1-1000 to find open services.")
    ]
    
    for title, cmd, desc in steps:
        console.print(f"\n[bold]{title}[/bold]")
        console.print(f"Command: [green]{cmd}[/green]")
        console.print(f"Action: {desc}")
    
    Prompt.ask("\n[bold yellow]Press Enter when you have practiced these in your terminals...[/bold yellow]")

def run_nmcli_demo():
    show_step(
        "Network Manager CLI (nmcli)",
        """
`nmcli` is used to manage NetworkManager. It's great for WiFi and static IPs from the terminal.

**Common Commands:**
* `nmcli dev wifi list`: List available WiFi networks.
* `nmcli con show`: Show active connections.
        """,
        "nmcli dev wifi list"
    )

def main():
    while True:
        clear()
        console.print(Panel("[bold blue]OSI NETWORK DOJO[/bold blue]\n[italic]Mastering Modern Linux Networking[/italic]", border_style="blue"))
        
        console.print("\n[1] ðŸ›‘ Stop Using Deprecated Tools")
        console.print("[2] ðŸŒ Modern Basics (ip a, ip r)")
        console.print("[3] ðŸ•µï¸ Finding Backdoors (ss)")
        console.print("[4] ðŸ› ï¸ Netcat Mastery")
        console.print("[5] ðŸ“¡ WiFi Manipulation (nmcli)")
        console.print("[6] ðŸ”¥ The Final Challenge")
        console.print("[Q] Quit")
        
        choice = Prompt.ask("\nSelect Module").upper()
        
        if choice == "1":
            console.print(Panel("""
[bold red]DEPRECATED:[/bold red] ifconfig, netstat, route, arp
[bold green]MODERN REPLACEMENTS:[/bold green]
* `ifconfig` -> `ip a`
* `netstat` -> `ss`
* `route` -> `ip r`
* `arp` -> `ip n`
            """))
            Prompt.ask("Press Enter...")
            
        elif choice == "2":
            show_step("IP Address & Interfaces", "Use `ip a` to see your IP addresses and MAC addresses.", "ip a")
            show_step("Routing Table", "Use `ip r` to see your default gateway and routes.", "ip r")
            
        elif choice == "3":
            show_step("Socket Statistics (ss)", 
                      "Use `ss -tulpn` to find listening ports. This detects backdoors!\nFlags: TCP, UDP, Listening, Process, Numeric.", 
                      "ss -tulpn")
            
        elif choice == "4":
            run_netcat_demo()
            
        elif choice == "5":
            run_nmcli_demo()
            
        elif choice == "6":
            clear()
            console.print(Panel("[bold red]FINAL CHALLENGE[/bold red]", border_style="red"))
            console.print(Markdown("""
**Mission:**
1.  Open a new terminal.
2.  Start a Netcat listener on port **9999**.
3.  Use `ss -tulpn` in this terminal to users verifying it's running.
4.  Scan for it using `nc -zvn 127.0.0.1 9000-10000`.
            """))
            command = "ss -tulpn | grep 9999"
            console.print(f"\nVerify with: [cmd]{command}[/cmd]")
            if Prompt.ask("Run verification? (y/n)") == 'y':
                os.system(command)
            Prompt.ask("Press Enter to finish...")
            
        elif choice == "Q":
            break

if __name__ == "__main__":
    main()
