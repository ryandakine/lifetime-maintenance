#!/usr/bin/env python3
"""OSI REST API - Mobile App & Integration Endpoints"""

from fastapi import FastAPI, HTTPException, Depends, Header
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import Optional, List
import json
import os
from datetime import datetime

app = FastAPI(
    title="OSI Intelligence API",
    description="RESTful API for On-Site Intelligence platform",
    version="1.0.0"
)

# CORS for mobile apps
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # In production, restrict to your domains
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Database paths
DB_FILE = "./clients.json"
LEADS_FILE = "./leads.json"
COMPETITORS_FILE = "./competitors.json"

# API Key authentication (simple version)
API_KEY =  "osi_secret_key_2025"  # In production, use env variable

def verify_api_key(x_api_key: str = Header(...)):
    if x_api_key != API_KEY:
        raise HTTPException(status_code=401, detail="Invalid API key")
    return x_api_key

# Data Models
class Client(BaseModel):
    id: int
    name: str
    contact: Optional[str] = ""
    email: Optional[str] = ""
    tier: str
    mrr: float
    hours_limit: float
    hours_used: float
    joined: str

class Lead(BaseModel):
    id: int
    name: str
    value: float
    stage: str
    notes: str
    date_added: str

class TimeLog(BaseModel):
    client_id: int
    hours: float
    description: str

# Helper functions
def load_json(path):
    if not os.path.exists(path): return []
    try:
        with open(path, 'r') as f: return json.load(f)
    except: return []

def save_json(path, data):
    with open(path, 'w') as f: json.dump(data, f, indent=4)

# ==================== ENDPOINTS ====================

@app.get("/")
def root():
    return {
        "service": "OSI Intelligence API",
        "version": "1.0.0",
        "status": "operational",
        "endpoints": {
            "clients": "/api/clients",
            "leads": "/api/leads",
            "competitors": "/api/competitors",
            "docs": "/docs"
        }
    }

# ==================== CLIENT ENDPOINTS ====================

@app.get("/api/clients", response_model=List[Client])
def get_clients(api_key: str = Depends(verify_api_key)):
    """Get all clients"""
    clients = load_json(DB_FILE)
    return clients

@app.get("/api/clients/{client_id}")
def get_client(client_id: int, api_key: str = Depends(verify_api_key)):
    """Get specific client by ID"""
    clients = load_json(DB_FILE)
    client = next((c for c in clients if c['id'] == client_id), None)
    if not client:
        raise HTTPException(status_code=404, detail="Client not found")
    return client

@app.post("/api/clients")
def create_client(client: Client, api_key: str = Depends(verify_api_key)):
    """Create new client"""
    clients = load_json(DB_FILE)
    clients.append(client.dict())
    save_json(DB_FILE, clients)
    return {"status": "success", "client": client}

@app.post("/api/clients/{client_id}/time")
def log_time(client_id: int, time_log: TimeLog, api_key: str = Depends(verify_api_key)):
    """Log time for a client"""
    clients = load_json(DB_FILE)
    client = next((c for c in clients if c['id'] == client_id), None)
    
    if not client:
        raise HTTPException(status_code=404, detail="Client not found")
    
    client['hours_used'] += time_log.hours
    save_json(DB_FILE, clients)
    
    return {
        "status": "success",
        "client": client['name'],
        "hours_logged": time_log.hours,
        "total_used": client['hours_used'],
        "remaining": client['hours_limit'] - client['hours_used']
    }

# ==================== LEAD ENDPOINTS ====================

@app.get("/api/leads")
def get_leads(api_key: str = Depends(verify_api_key)):
    """Get all leads"""
    leads = load_json(LEADS_FILE)
    return leads

@app.post("/api/leads")
def create_lead(lead: Lead, api_key: str = Depends(verify_api_key)):
    """Create new lead"""
    leads = load_json(LEADS_FILE)
    leads.append(lead.dict())
    save_json(LEADS_FILE, leads)
    return {"status": "success", "lead": lead}

@app.patch("/api/leads/{lead_id}/stage")
def update_lead_stage(lead_id: int, stage: str, api_key: str = Depends(verify_api_key)):
    """Update lead stage"""
    leads = load_json(LEADS_FILE)
    lead = next((l for l in leads if l['id'] == lead_id), None)
    
    if not lead:
        raise HTTPException(status_code=404, detail="Lead not found")
    
    lead['stage'] = stage
    save_json(LEADS_FILE, leads)
    
    return {"status": "success", "lead": lead}

# ==================== COMPETITOR ENDPOINTS ====================

@app.get("/api/competitors")
def get_competitors(api_key: str = Depends(verify_api_key)):
    """Get all competitors"""
    competitors = load_json(COMPETITORS_FILE)
    return competitors

# ==================== STATS ENDPOINTS ====================

@app.get("/api/stats")
def get_stats(api_key: str = Depends(verify_api_key)):
    """Get business metrics"""
    clients = load_json(DB_FILE)
    leads = load_json(LEADS_FILE)
    
    total_mrr = sum(c.get('mrr', 0) for c in clients)
    total_pipeline = sum(l.get('value', 0) for l in leads)
    
    return {
        "clients": {
            "total": len(clients),
            "mrr": total_mrr
        },
        "leads": {
            "total": len(leads),
            "pipeline_value": total_pipeline,
            "by_stage": {
                stage: len([l for l in leads if l['stage'] == stage])
                for stage in ["Discovery", "Proposal", "Negotiation", "Closing"]
            }
        },
        "timestamp": datetime.now().isoformat()
    }

if __name__ == "__main__":
    import uvicorn
    print("ðŸš€ Starting OSI API Server...")
    print("ðŸ“¡ API Documentation: http://localhost:8080/docs")
    print("ðŸ”‘ API Key: osi_secret_key_2025")
    uvicorn.run(app, host="0.0.0.0", port=8080)
