#!/usr/bin/env python3
import time
import random
import threading
from rich.console import Console
from rich.table import Table
from rich.tree import Tree
from rich.panel import Panel
from rich.layout import Layout
from rich.live import Live

console = Console()

class MeshNode:
    def __init__(self, node_id, ip, role="EDGE", battery=100):
        self.id = node_id
        self.ip = ip
        self.role = role
        self.status = "ONLINE"
        self.load = 0.0 # 0-100%
        self.battery = battery
        self.tasks = []
        
    def tick(self):
        # Simulate load variation and battery drain
        if self.status == "ONLINE":
            self.load = max(0, min(100, self.load + random.uniform(-10, 10)))
            if self.role == "EDGE":
                self.battery = max(0, self.battery - random.uniform(0.1, 0.5))
            
            # Artificial failure
            if random.random() < 0.01: # 1% chance of temporary glitch
                self.status = "UNSTABLE"
        elif self.status == "UNSTABLE":
            self.status = "ONLINE" if random.random() > 0.5 else "OFFLINE"
        elif self.status == "OFFLINE":
            # Self-healing attempt
            if random.random() > 0.8:
                self.status = "ONLINE"
                console.log(f"[green]Node {self.id} recovered autonomously.[/green]")

class MeshController:
    def __init__(self):
        self.nodes = []
        self.running = True
        
        # Init Mock Mesh
        self.nodes.append(MeshNode("HUB-01", "192.168.1.10", "HUB", 100))
        for i in range(1, 6):
            self.nodes.append(MeshNode(f"NODE-0{i}", f"192.168.1.1{i}", "EDGE", random.randint(80, 100)))
            
    def run_simulation(self):
        with Live(self.generate_view(), refresh_per_second=2) as live:
            while self.running:
                for node in self.nodes:
                    node.tick()
                    
                # Load Balancing Logic
                hub = self.nodes[0]
                total_load = sum(n.load for n in self.nodes)
                if total_load > 300: # High load
                    console.log("[yellow]Mesh Load High - Scaling tasks...[/yellow]")
                    
                live.update(self.generate_view())
                time.sleep(0.5)
                
    def generate_view(self):
        layout = Layout()
        layout.split_column(
            Layout(name="map", ratio=2),
            Layout(name="stats", ratio=1)
        )
        
        # Network Map
        tree = Tree("üåê [bold]OSI MESH NETWORK[/bold]")
        hub = tree.add(f"[bold cyan]HUB-01[/bold cyan] (Primary) - {self.nodes[0].status}")
        
        for n in self.nodes[1:]:
            style = "green" if n.status == "ONLINE" else "red"
            hub.add(f"[{style}]{n.id}[/{style}] | Load: {n.load:.1f}% | Bat: {n.battery:.1f}%")
            
        layout["map"].update(Panel(tree, title="Topology View"))
        
        # Stats Table
        table = Table(title="Node Telemetry")
        table.add_column("Node ID")
        table.add_column("IP Address")
        table.add_column("Role")
        table.add_column("Status")
        table.add_column("CPU Load")
        
        for n in self.nodes:
            status_style = "green" if n.status == "ONLINE" else "red"
            table.add_row(n.id, n.ip, n.role, f"[{status_style}]{n.status}[/{status_style}]", f"{n.load:.1f}%")
            
        layout["stats"].update(table)
        
        return layout

if __name__ == "__main__":
    try:
        mesh = MeshController()
        mesh.run_simulation()
    except KeyboardInterrupt:
        console.print("[yellow]Mesh Simulation Stopped.[/yellow]")
