#!/usr/bin/env python3
import sys
import time
import psutil
import socket
import json
import threading
from flask import Flask, request, jsonify

# Agent running on the Edge Node (Raspberry Pi 4/5)
app = Flask(__name__)

NODE_ID = socket.gethostname()
ROLE = "EDGE"
HUB_IP = None # To be configured

@app.route('/status', methods=['GET'])
def get_status():
    """Report telemetry to Controller"""
    try:
        temp = 0
        # Pi specific temp check
        with open("/sys/class/thermal/thermal_zone0/temp", "r") as f:
            temp = float(f.read()) / 1000.0
    except:
        temp = 0.0

    stats = {
        "id": NODE_ID,
        "role": ROLE,
        "cpu_percent": psutil.cpu_percent(),
        "memory_percent": psutil.virtual_memory().percent,
        "temperature": temp,
        "status": "ONLINE"
    }
    return jsonify(stats)

@app.route('/task/exec', methods=['POST'])
def execute_task():
    """Receive task from Controller"""
    data = request.json
    task_type = data.get('type')
    
    # Simulate execution
    print(f"Executing Task: {task_type}")
    time.sleep(1) # Fake work
    
    return jsonify({"status": "completed", "result": "Task Done"})

if __name__ == "__main__":
    # Run agent
    print(f"OSI MESH NODE '{NODE_ID}' STARTED on Port 5000")
    app.run(host='0.0.0.0', port=5000)
