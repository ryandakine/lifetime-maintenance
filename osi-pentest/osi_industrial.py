#!/usr/bin/env python3
import sys
import pandas as pd
import numpy as np
from datetime import datetime, timedelta
from rich.console import Console
from rich.table import Table
from rich.panel import Panel

console = Console()

class IndustrialBrain:
    def __init__(self):
        # In-memory mock database for prototype
        # Columns: PartID, Name, Criticality (1-10), HoursRun, MTBF (Mean Time Between Failures), Stock, LeadTime
        data = {
            'PartID': ['HYD-001', 'SHR-BLADE', 'CONV-BELT', 'BEARING-X', 'MOTOR-MAIN'],
            'Name': ['Hydraulic Cylinder', 'Shredder Blade Set', 'Conveyor Belt 48"', 'Roller Bearing', 'Main Drive Motor'],
            'Category': ['Hydraulics', 'Wear Parts', 'Conveyance', 'Hardware', 'Power'],
            'Criticality': [9, 8, 6, 4, 10],
            'HoursRun': [450, 1200, 3000, 500, 15000],
            'MTBF_Hours': [2000, 1500, 5000, 10000, 50000],
            'Stock': [1, 2, 0, 10, 1],
            'LeadTime_Days': [14, 21, 5, 2, 90],
            'Cost': [450, 2500, 800, 45, 12000]
        }
        self.inventory = pd.DataFrame(data)
        console.print("[bold green]OSI INDUSTRIAL - SYSTEM ONLINE[/bold green]")

    def run_analysis(self):
        """Analyze Critical Failures & Stock Risks"""
        console.print("\n[bold cyan]RUNNING PREDICTIVE ANALYSIS...[/bold cyan]")
        
        # 1. Calculate Risk Score
        # Risk = (Criticality * 100) / Stock (Higher is bad) + (HoursRun / MTBF)
        # Avoid div/0 for stock, treat 0 as 0.1
        
        results = []
        for idx, row in self.inventory.iterrows():
            # Failure Probability based on Weibull-like aging (Simplified linear here)
            health_pct = max(0, 1.0 - (row['HoursRun'] / row['MTBF_Hours']))
            failure_risk_pct = (1.0 - health_pct) * 100
            
            # Stock Risk
            if row['Stock'] == 0:
                stock_status = "[red]STOCKOUT[/red]"
            elif row['Stock'] < 2:
                stock_status = "[yellow]LOW[/yellow]"
            else:
                stock_status = "[green]OK[/green]"
                
            # Prediction
            # Remaining Hours
            remaining = row['MTBF_Hours'] - row['HoursRun']
            # Assume 12 hours/day operation
            days_remaining = remaining / 12
            est_fail_date = (datetime.now() + timedelta(days=days_remaining)).strftime('%Y-%m-%d')
            
            # Reorder Point logic
            # Daily Usage (Approximation: 1 failure per MTBF) -> 1 / (MTBF/12) parts per day?
            # Simplified: ROP = LeadTime / (MTBF/12) * SafetyFactor(1.5)
            # Just flagging if (Days Remaining < Lead Time * 2)
            
            action = "None"
            if days_remaining < (row['LeadTime_Days'] * 1.5) or row['Stock'] == 0:
                action = "[bold red]ORDER NOW[/bold red]"
                
            results.append({
                "Part": row['Name'],
                "Health": f"{health_pct*100:.1f}%",
                "EstFail": est_fail_date,
                "Stock": f"{row['Stock']} ({stock_status})",
                "Action": action
            })

        # Display Report
        table = Table(title="Predictive Maintenance Report")
        table.add_column("Part")
        table.add_column("Health")
        table.add_column("Est. Failure")
        table.add_column("Stock")
        table.add_column("Rec. Action")
        
        for r in results:
            table.add_row(r['Part'], r['Health'], r['EstFail'], r['Stock'], r['Action'])
            
        console.print(table)
        
        # AI Insight (Mocked for now, but logical)
        console.print(Panel(
            "[bold red]CRITICAL ALERT:[/bold red] Hydraulic Cylinder health is 77%, but Lead Time is 14 days.\n"
            "Based on usage trend, we recommend ordering 1 unit immediately to prevent potential 48hr downtime.",
            title="ðŸ¤– OSI AI OPERATOR INSIGHT", border_style="red"
        ))

    def query_inventory(self, query):
        """Natural Language-ish Search"""
        console.print(f"Searching for: '{query}'")
        # Simple substring match
        matches = self.inventory[self.inventory['Name'].str.contains(query, case=False)]
        if matches.empty:
            console.print("[yellow]No parts found.[/yellow]")
        else:
            console.print(matches[['PartID', 'Name', 'Stock', 'Location']])

if __name__ == "__main__":
    brain = IndustrialBrain()
    brain.run_analysis()
