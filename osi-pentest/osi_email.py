#!/usr/bin/env python3
"""OSI Email Integration - Send documents directly to clients"""

import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.application import MIMEApplication
import os
from datetime import datetime

class OSIEmailer:
    """Send professional emails with attachments"""
    
    def __init__(self, smtp_server="smtp.gmail.com", smtp_port=587):
        self.smtp_server = smtp_server
        self.smtp_port = smtp_port
        # In production, these should be environment variables
        self.from_email = os.getenv("OSI_EMAIL", "")
        self.from_password = os.getenv("OSI_EMAIL_PASSWORD", "")
    
    def send_invoice(self, to_email, client_name, invoice_pdf_path, amount):
        """Send invoice email with PDF attachment"""
        
        subject = f"Invoice from On-Site Intelligence - {datetime.now().strftime('%B %Y')}"
        
        body = f"""Dear {client_name} Team,

Thank you for your continued partnership with On-Site Intelligence LLC.

Please find attached your invoice for ${amount:,.2f}.

Payment is due within 30 days of receipt. If you have any questions, please don't hesitate to reach out.

Best regards,
Ryan Brenny
CEO & Founder
On-Site Intelligence LLC

---
Email: ryan@osi-cyber.com
Web: https://osi-cyber.com
"""
        
        return self._send_email_with_attachment(
            to_email,
            subject,
            body,
            invoice_pdf_path,
            f"Invoice_{client_name.replace(' ', '_')}.pdf"
        )
    
    def send_proposal(self, to_email, client_name, proposal_text, attachment_path=None):
        """Send proposal email"""
        
        subject = f"Security Proposal for {client_name}"
        
        body = f"""Dear {client_name} Team,

Thank you for the opportunity to propose our cybersecurity services.

{proposal_text}

This proposal is valid for 30 days. I'm available for a call this week to discuss any questions.

Looking forward to partnering with you!

Best regards,
Ryan Brenny
CEO & Founder
On-Site Intelligence LLC

---
Email: ryan@osi-cyber.com
Web: https://osi-cyber.com
"""
        
        if attachment_path and os.path.exists(attachment_path):
            return self._send_email_with_attachment(
                to_email,
                subject,
                body,
                attachment_path,
                f"Proposal_{client_name.replace(' ', '_')}.pdf"
            )
        else:
            return self._send_email(to_email, subject, body)
    
    def send_nda(self, to_email, client_name, nda_pdf_path):
        """Send NDA for signature"""
        
        subject = f"Non-Disclosure Agreement - OSI & {client_name}"
        
        body = f"""Dear {client_name} Team,

As discussed, please find attached the Non-Disclosure Agreement for our upcoming engagement.

Please review, sign, and return at your earliest convenience.

If you have any questions about the terms, I'm happy to discuss.

Best regards,
Ryan Brenny
CEO & Founder
On-Site Intelligence LLC

---
Email: ryan@osi-cyber.com
Web: https://osi-cyber.com
"""
        
        return self._send_email_with_attachment(
            to_email,
            subject,
            body,
            nda_pdf_path,
            f"NDA_{client_name.replace(' ', '_')}.pdf"
        )
    
    def _send_email(self, to_email, subject, body):
        """Send plain email"""
        
        if not self.from_email or not self.from_password:
            return False, "Email credentials not configured. Set OSI_EMAIL and OSI_EMAIL_PASSWORD environment variables."
        
        try:
            msg = MIMEMultipart()
            msg['From'] = self.from_email
            msg['To'] = to_email
            msg['Subject'] = subject
            
            msg.attach(MIMEText(body, 'plain'))
            
            server = smtplib.SMTP(self.smtp_server, self.smtp_port)
            server.starttls()
            server.login(self.from_email, self.from_password)
            server.send_message(msg)
            server.quit()
            
            return True, "Email sent successfully!"
        except Exception as e:
            return False, f"Failed to send email: {str(e)}"
    
    def _send_email_with_attachment(self, to_email, subject, body, attachment_path, attachment_name):
        """Send email with PDF attachment"""
        
        if not self.from_email or not self.from_password:
            return False, "Email credentials not configured. Set OSI_EMAIL and OSI_EMAIL_PASSWORD environment variables."
        
        if not os.path.exists(attachment_path):
            return False, f"Attachment not found: {attachment_path}"
        
        try:
            msg = MIMEMultipart()
            msg['From'] = self.from_email
            msg['To'] = to_email
            msg['Subject'] = subject
            
            msg.attach(MIMEText(body, 'plain'))
            
            # Attach PDF
            with open(attachment_path, 'rb') as f:
                attach = MIMEApplication(f.read(), _subtype='pdf')
                attach.add_header('Content-Disposition', 'attachment', filename=attachment_name)
                msg.attach(attach)
            
            server = smtplib.SMTP(self.smtp_server, self.smtp_port)
            server.starttls()
            server.login(self.from_email, self.from_password)
            server.send_message(msg)
            server.quit()
            
            return True, f"Email sent successfully to {to_email}!"
        except Exception as e:
            return False, f"Failed to send email: {str(e)}"

if __name__ == "__main__":
    # Test
    emailer = OSIEmailer()
    print("Email integration module loaded successfully!")
