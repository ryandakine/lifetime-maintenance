#!/usr/bin/env python3
import argparse
import sys
import docker
import time
import json
from rich.console import Console
from rich.progress import Progress, SpinnerColumn, TextColumn
from rich.panel import Panel
from rich.text import Text
from datetime import datetime
import os

# Initialize Rich Console
console = Console()

class OSIScanner:
    def __init__(self, target):
        self.target = target
        self.client = docker.from_env()
        self.container_name = "osi-kali-runner"
        self.results = {}
        
    def print_banner(self):
        with open("banner.txt", "r") as f:
            banner = f.read()
        console.print(Text(banner, style="bold green"))
        console.print(Panel(f"[bold white]Target:[/bold white] [cyan]{self.target}[/cyan]\n[bold white]Date:[/bold white] [cyan]{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}[/cyan]", border_style="green", title="OSI SCOUT v1.0"))

    def start_container(self):
        """Starts a persistent Kali container to run commands."""
        try:
            # Check if running
            try:
                container = self.client.containers.get(self.container_name)
                if container.status != "running":
                    container.start()
            except docker.errors.NotFound:
                console.print("[yellow]Spawning new Kali Linux container...[/yellow]")
                self.client.containers.run(
                    "osi/kali-full", 
                    "tail -f /dev/null", 
                    name=self.container_name, 
                    detach=True,
                    auto_remove=True,
                    privileged=True
                )
            
            # Ensure tools are installed (Nmap is usually pre-installed or needs a quick apt)
            # For speed, we assume the user might want to build a custom image later.
            # But we'll run a quick check/install.
            # self.run_command("apt-get update && apt-get install -y nmap inetutils-ping", silent=True) # REMOVED: Built-in now
            return True
        except Exception as e:
            console.print(f"[bold red]Error starting Docker:[/bold red] {e}")
            return False

    def run_command(self, cmd, silent=False):
        """Executes a command inside the Kali container."""
        container = self.client.containers.get(self.container_name)
        if not silent:
            console.print(f"[dim]Executing: {cmd}[/dim]")
        
        exit_code, output = container.exec_run(cmd)
        
        if exit_code != 0 and not silent:
            console.print(f"[red]Command failed:[/red] {output.decode('utf-8')}")
        
        return output.decode('utf-8')

    def phase_1_discovery(self):
        """Phase 1: Discovery & Ping"""
        console.print("\n[bold cyan]‚îÄ‚îÄ PHASE 1: RECONNAISSANCE ‚îÄ‚îÄ[/bold cyan]")
        with Progress(SpinnerColumn(), TextColumn("[progress.description]{task.description}"), transient=True) as progress:
            task = progress.add_task(description="Pinging target...", total=None)
            res = self.run_command(f"ping -c 3 {self.target}")
            
            if "0 packets received" in res:
                console.print("[bold red]‚ùå Target is DOWN or blocking ping.[/bold red]")
                return False
            else:
                console.print(f"[bold green]‚úî Target is UP[/bold green]")
                return True

    def phase_2_nmap(self):
        """Phase 2: Nmap Scan"""
        console.print("\n[bold cyan]‚îÄ‚îÄ PHASE 2: PORT SCANNING (NMAP) ‚îÄ‚îÄ[/bold cyan]")
        with Progress(SpinnerColumn(), TextColumn("[progress.description]{task.description}"), transient=True) as progress:
            progress.add_task(description="Running Nmap (Top 100 ports)...", total=None)
            # Using -sS (Stealth Syn) requires root, which Docker is by default
            res = self.run_command(f"nmap -sS --top-ports 100 -T4 {self.target}")
            
            console.print(Panel(res.strip(), title="Nmap Results", border_style="blue"))
            self.results['nmap'] = res
            return True

    def phase_3_web_scan(self):
        """Phase 3: Web Vulnerability Scan (Nikto)"""
        # Only run if port 80 or 443 was found open in Nmap
        if '80/tcp open' not in self.results.get('nmap', '') and '443/tcp open' not in self.results.get('nmap', ''):
            console.print("[yellow]Skipping Web Scan (No web ports found)[/yellow]")
            return

        console.print("\n[bold cyan]‚îÄ‚îÄ PHASE 3: WEB VULNERABILITY SCAN (NIKTO) ‚îÄ‚îÄ[/bold cyan]")
        with Progress(SpinnerColumn(), TextColumn("[progress.description]{task.description}"), transient=True) as progress:
            progress.add_task(description="Scanning web server...", total=None)
            # Run Nikto
            res = self.run_command(f"nikto -h {self.target} -maxtime 60") # Cap at 60s for demo speed
            
            console.print(Panel(res.strip(), title="Nikto Results", border_style="magenta"))
            self.results['nikto'] = res

    def phase_4_ai_analysis(self):
        """Phase 4: AI Analysis using Local Ollama (Llama 3)"""
        console.print("\n[bold cyan]‚îÄ‚îÄ PHASE 4: AI VULNERABILITY ANALYSIS (LLAMA 3) ‚îÄ‚îÄ[/bold cyan]")
        
        # Prepare context for AI
        context = f"Target: {self.target}\n"
        context += f"Nmap Results:\n{self.results.get('nmap', 'No Data')}\n"
        if 'nikto' in self.results:
            context += f"Nikto Web Scan:\n{self.results.get('nikto', '')}\n"
            
        prompt = f"""You are an elite cybersecurity penetration tester for On-Site Intelligence (OSI).
        Analyze the following scan data for the target IP: {self.target}.
        
        Identify the top 3 critical security risks or interesting open ports.
        For each, recommend a specific tool or command to verify the vulnerability (e.g. 'Use hydra on port 22').
        Keep the response professional, concise, and actionable (bullet points).
        
        SCAN DATA:
        {context}
        """
        
        try:
            with Progress(SpinnerColumn(), TextColumn("[progress.description]{task.description}"), transient=True) as progress:
                progress.add_task(description="Querying Local Llama 3 AI...", total=None)
                
                # Call local Ollama API
                payload = {
                    "model": "llama3",
                    "prompt": prompt,
                    "stream": False
                }
                response = requests.post("http://localhost:11434/api/generate", json=payload, timeout=120)
                
                if response.status_code == 200:
                    ai_text = response.json()['response']
                    console.print(Panel(ai_text.strip(), title="ü§ñ OSI AI SENTINEL ANALYSIS", border_style="green"))
                    self.results['ai_analysis'] = ai_text
                else:
                    console.print("[red]AI connection failed (Status {response.status_code})[/red]")
                    self.results['ai_analysis'] = "AI Analysis failed to generate."
                    
        except Exception as e:
            console.print(f"[red]Error connecting to Ollama: {e}[/red]")
            console.print("[yellow]Ensure Ollama is running: 'ollama serve'[/yellow]")

    def generate_pdf_report(self):
        """Generates a professional OSI branded PDF report."""
        from fpdf import FPDF
        
        class PDF(FPDF):
            def header(self):
                # Logo would go here
                self.set_font('Courier', 'B', 15)
                self.cell(0, 10, 'OSI SECURITY ASSESSMENT', 0, 1, 'C')
                self.ln(5)
            
            def footer(self):
                self.set_y(-15)
                self.set_font('Courier', 'I', 8)
                self.cell(0, 10, f'Page {self.page_no()} - CONFIDENTIAL - On-Site Intelligence LLC', 0, 0, 'C')

        pdf = PDF()
        pdf.add_page()
        pdf.set_font("Courier", size=12)
        
        # Title Info
        pdf.set_font("Courier", 'B', 14)
        pdf.cell(0, 10, f"Target: {self.target}", 0, 1)
        pdf.cell(0, 10, f"Date: {datetime.now().strftime('%Y-%m-%d %H:%M')}", 0, 1)
        pdf.ln(10)
        
        # Executive Summary (Now AI Powered!)
        pdf.set_font("Courier", 'B', 12)
        pdf.cell(0, 10, "1. AI Executive Summary (Llama 3)", 0, 1)
        pdf.set_font("Courier", size=10)
        
        ai_summary = self.results.get('ai_analysis', 'AI Analysis not performed.').replace('\r', '').encode('latin-1', 'replace').decode('latin-1')
        pdf.multi_cell(0, 5, ai_summary)
        pdf.ln(5)
        
        # Nmap Results
        pdf.set_font("Courier", 'B', 12)
        pdf.cell(0, 10, "2. Network Scan (Nmap)", 0, 1)
        pdf.set_font("Courier", size=8)
        nmap_clean = self.results.get('nmap', 'No Data').replace('\r', '').encode('latin-1', 'replace').decode('latin-1')
        pdf.multi_cell(0, 4, nmap_clean)
        pdf.ln(5)
        
        # Web Results
        if 'nikto' in self.results:
            pdf.set_font("Courier", 'B', 12)
            pdf.cell(0, 10, "3. Web Vulnerability Scan (Nikto)", 0, 1)
            pdf.set_font("Courier", size=8)
            nikto_clean = self.results.get('nikto', 'No Issues').replace('\r', '').encode('latin-1', 'replace').decode('latin-1')
            pdf.multi_cell(0, 4, nikto_clean)
            
        # 5G Results
        if '5g_audit' in self.results:
            pdf.ln(5)
            pdf.set_font("Courier", 'B', 12)
            pdf.cell(0, 10, "4. 5G Infrastructure Audit (GTP-U)", 0, 1)
            pdf.set_font("Courier", size=8)
            g5_res = self.results.get('5g_audit', 'No Data')
            pdf.multi_cell(0, 4, g5_res)
        
        filename = f"OSI_Report_{self.target}_{datetime.now().strftime('%Y%m%d')}.pdf"
        pdf.output(filename)
        console.print(f"\n[bold green]Report generated: {filename}[/bold green]")

    def cleanup(self):
        """Stops the container."""
        try:
            container = self.client.containers.get(self.container_name)
            container.stop()
            console.print("[dim]Container stopped.[/dim]")
        except:
            pass


    def phase_5g_audit(self):
        """Phase 5G: Global Title & GTP Audit"""
        try:
            from osi_5g import GTPAuditor
            auditor = GTPAuditor(self.target)
            res = auditor.run()
            self.results['5g_audit'] = res
            return True
        except ImportError:
            console.print("[red]Error: osi_5g module not found or Scapy missing.[/red]")
            return False

def main():
    parser = argparse.ArgumentParser(description='OSI Scout - Containerized Pen Testing Tool')
    parser.add_argument('target', help='Target IP address or hostname')
    parser.add_argument('--mode', choices=['full', '5g', 'web'], default='full', help='Scan mode: full (default), 5g (GTP/TEID), web (Nikto only)')
    args = parser.parse_args()

    scanner = OSIScanner(args.target)
    scanner.print_banner()

    # Special handling for 5G mode (runs on host mostly)
    if args.mode == '5g':
        scanner.phase_5g_audit()
        # We can still generate a report for the 5G finding
        scanner.generate_pdf_report()
        return

    if scanner.start_container():
        try:
            if scanner.phase_1_discovery():
                scanner.phase_2_nmap()
                
                if args.mode == 'web' or args.mode == 'full':
                    scanner.phase_3_web_scan()
                
                scanner.phase_4_ai_analysis()
                scanner.generate_pdf_report()
        except KeyboardInterrupt:
            console.print("\n[yellow]Scan interrupted by user.[/yellow]")
        finally:
            scanner.cleanup()

if __name__ == "__main__":
    main()
