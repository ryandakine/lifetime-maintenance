#!/usr/bin/env python3
"""OSI Pentesting Progress Tracker - GUI for Daily Logging"""

import streamlit as st
import json
import os
from datetime import datetime, date

# Database
LOG_FILE = "./pentesting_log.json"

def load_log():
    if not os.path.exists(LOG_FILE):
        return {"days": {}, "start_date": date.today().isoformat()}
    try:
        with open(LOG_FILE, 'r') as f:
            return json.load(f)
    except:
        return {"days": {}, "start_date": date.today().isoformat()}

def save_log(data):
    with open(LOG_FILE, 'w') as f:
        json.dump(data, f, indent=4)

st.set_page_config(page_title="Pentesting Log", page_icon="üìä", layout="wide")

# Hacker Green Theme
st.markdown("""
<style>
    .stApp {
        background-color: #0a0e0f;
        color: #00ff41;
    }
    
    .stMarkdown, .stText, p, span, div {
        color: #00ff41 !important;
    }
    
    h1, h2, h3 {
        color: #00ff00 !important;
        text-shadow: 0 0 10px #00ff41;
    }
    
    .stButton > button {
        background-color: #003300;
        color: #00ff41 !important;
        border: 2px solid #00ff41;
    }
</style>
""", unsafe_allow_html=True)

st.title("üî• PENTESTING BOOTCAMP TRACKER")
st.markdown("*14-Day Journey to Dangerous*")

# Load data
log_data = load_log()
start_date = datetime.fromisoformat(log_data["start_date"]).date()
today = date.today()
day_number = (today - start_date).days + 1

st.markdown(f"### üìÖ Day {day_number} of 14 - {today.strftime('%B %d, %Y')}")

# Get today's data
today_key = today.isoformat()
if today_key not in log_data["days"]:
    log_data["days"][today_key] = {
        "sessions": [],
        "completed": [],
        "boxes_rooted": [],
        "tools_learned": [],
        "notes": "",
        "biggest_win": "",
        "biggest_challenge": "",
        "tomorrow_focus": ""
    }

today_data = log_data["days"][today_key]

# Tabs
tab1, tab2, tab3 = st.tabs(["‚è±Ô∏è Log Session", "üìä Today's Summary", "üèÜ Overall Stats"])

with tab1:
    st.subheader("Log a Work Session")
    
    with st.form("session_form", clear_on_submit=True):
        st.markdown("### Log Session")
        
        # Option to use manual time or clock time
        log_method = st.radio("Logging Method", ["Current Time", "Manual Entry"], horizontal=True, index=1)
        
        col1, col2 = st.columns(2)
        
        if log_method == "Current Time":
            st.caption("‚ö†Ô∏è Use this only if logging RIGHT NOW. For past work, use 'Manual Entry'.")
            with col1:
                # Default to now, but allow user to change it without reset
                session_start = st.time_input("Start Time", value=None) 
            with col2:
                session_end = st.time_input("End Time", value=None)
            
            # Calculate hours preview
            start_dt = datetime.combine(today, session_start)
            end_dt = datetime.combine(today, session_end)
            hours_preview = (end_dt - start_dt).total_seconds() / 3600
            if hours_preview < 0: hours_preview += 24
            st.caption(f"Calculated Duration: {hours_preview:.2f} hours")
            
        else: # Manual Entry
            with col1:
                manual_hours = st.number_input("Hours Worked", min_value=0.1, max_value=24.0, value=1.0, step=0.25)
            with col2:
                time_description = st.text_input("Time Range (Optional)", placeholder="e.g. 2:30 AM - 3:15 AM")
        
        session_description = st.text_area("What did you work on this session?", 
            placeholder="e.g., Completed Linux Fundamentals Part 1, started Nmap room")
        
        if st.form_submit_button("üíæ Log Session", type="primary"):
            if log_method == "Current Time":
                # Calculate hours
                start_dt = datetime.combine(today, session_start)
                end_dt = datetime.combine(today, session_end)
                hours = (end_dt - start_dt).total_seconds() / 3600
                if hours < 0: hours += 24 # Handle overnight sessions
                
                session = {
                    "start": session_start.strftime("%I:%M %p"),
                    "end": session_end.strftime("%I:%M %p"),
                    "hours": round(hours, 2),
                    "description": session_description
                }
            else:
                session = {
                    "start": "Manual Entry",
                    "end": time_description if time_description else "Manual Entry",
                    "hours": manual_hours,
                    "description": session_description
                }
            
            today_data["sessions"].append(session)
            save_log(log_data)
            st.success(f"‚úÖ Logged session!")
            st.rerun()
    
    # Show today's sessions
    if today_data["sessions"]:
        st.markdown("---")
        st.subheader("Today's Sessions")
        
        total_hours = 0
        for i, session in enumerate(today_data["sessions"]):
            col1, col2 = st.columns([5, 1])
            with col1:
                st.markdown(f"**Session {i+1}:** {session['start']} - {session['end']} ({session['hours']} hrs)")
                st.caption(session['description'])
            with col2:
                # Delete button
                if st.button("üóëÔ∏è", key=f"del_session_{i}"):
                    today_data["sessions"].pop(i)
                    save_log(log_data)
                    st.rerun()
            
            total_hours += session['hours']
            st.markdown("---")
        
        st.metric("Total Hours Today", f"{total_hours:.2f}")

with tab2:
    st.subheader("üìã Daily Progress")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("### ‚úÖ Completed Tasks")
        new_task = st.text_input("Add completed task", placeholder="e.g., Linux Fundamentals Part 1")
        if st.button("Add Task"):
            if new_task:
                today_data["completed"].append(new_task)
                save_log(log_data)
                st.rerun()
        
        for i, task in enumerate(today_data["completed"]):
            col_a, col_b = st.columns([4, 1])
            col_a.write(f"‚úÖ {task}")
            if col_b.button("üóëÔ∏è", key=f"del_task_{i}"):
                today_data["completed"].pop(i)
                save_log(log_data)
                st.rerun()
    
    with col2:
        st.markdown("### üéØ Boxes Rooted")
        new_box = st.text_input("Add rooted box", placeholder="e.g., HTB: Lame")
        if st.button("Add Box"):
            if new_box:
                today_data["boxes_rooted"].append(new_box)
                save_log(log_data)
                st.rerun()
        
        for i, box in enumerate(today_data["boxes_rooted"]):
            col_a, col_b = st.columns([4, 1])
            col_a.write(f"üíÄ {box}")
            if col_b.button("üóëÔ∏è", key=f"del_box_{i}"):
                today_data["boxes_rooted"].pop(i)
                save_log(log_data)
                st.rerun()
    
    st.markdown("---")
    
    # Daily reflection
    with st.form("reflection_form"):
        st.subheader("üìù Daily Reflection")
        
        biggest_win = st.text_area("Biggest Win Today", 
            value=today_data.get("biggest_win", ""),
            placeholder="What felt impossible that you figured out?")
        
        biggest_challenge = st.text_area("Biggest Challenge", 
            value=today_data.get("biggest_challenge", ""),
            placeholder="What kicked your ass today?")
        
        notes = st.text_area("Notes / Discoveries", 
            value=today_data.get("notes", ""),
            placeholder="Key things to remember")
        
        tomorrow_focus = st.text_area("Tomorrow's Focus", 
            value=today_data.get("tomorrow_focus", ""),
            placeholder="What's the priority for tomorrow?")
        
        energy_level = st.slider("Energy Level", 1, 10, 5)
        
        if st.form_submit_button("üíæ Save Reflection", type="primary"):
            today_data["biggest_win"] = biggest_win
            today_data["biggest_challenge"] = biggest_challenge
            today_data["notes"] = notes
            today_data["tomorrow_focus"] = tomorrow_focus
            today_data["energy_level"] = energy_level
            save_log(log_data)
            st.success("‚úÖ Reflection saved!")

with tab3:
    st.subheader("üèÜ Bootcamp Statistics")
    
    # Calculate overall stats
    total_days = len(log_data["days"])
    total_hours = sum(
        sum(s["hours"] for s in day["sessions"]) 
        for day in log_data["days"].values()
    )
    total_boxes = sum(
        len(day["boxes_rooted"]) 
        for day in log_data["days"].values()
    )
    total_tasks = sum(
        len(day["completed"]) 
        for day in log_data["days"].values()
    )
    
    col1, col2, col3, col4 = st.columns(4)
    col1.metric("Days Completed", f"{total_days}/14")
    col2.metric("Total Hours", f"{total_hours:.1f}")
    col3.metric("Boxes Rooted", total_boxes)
    col4.metric("Tasks Done", total_tasks)
    
    # Progress bar
    progress = (total_days / 14) * 100
    st.progress(total_days / 14)
    st.caption(f"{progress:.0f}% Complete")
    
    # Daily breakdown
    st.markdown("---")
    st.subheader("üìÖ Daily Breakdown")
    
    for day_key in sorted(log_data["days"].keys(), reverse=True):
        day_data = log_data["days"][day_key]
        day_date = datetime.fromisoformat(day_key).date()
        day_num = (day_date - start_date).days + 1
        
        with st.expander(f"Day {day_num} - {day_date.strftime('%b %d')}", expanded=False):
            day_hours = sum(s["hours"] for s in day_data["sessions"])
            
            st.write(f"**Hours:** {day_hours:.2f}")
            st.write(f"**Tasks:** {len(day_data['completed'])}")
            st.write(f"**Boxes:** {len(day_data['boxes_rooted'])}")
            
            if day_data.get("biggest_win"):
                st.markdown(f"**üí™ Win:** {day_data['biggest_win']}")
            
            if day_data["boxes_rooted"]:
                st.markdown("**Boxes Rooted:**")
                for box in day_data["boxes_rooted"]:
                    st.write(f"  ‚Ä¢ {box}")

# Footer
st.markdown("---")
st.caption("üíÄ The only way out is through. Keep hacking.")

if __name__ == "__main__":
    pass
