#!/usr/bin/env python3
import sys
from datetime import datetime
from rich.console import Console
from rich.prompt import Prompt, IntPrompt
from rich.panel import Panel
from fpdf import FPDF

console = Console()

class ProposalPDF(FPDF):
    def header(self):
        self.set_font('Helvetica', 'B', 15)
        self.cell(0, 10, 'On-Site Intelligence (OSI) - Strategic Security Proposal', 0, 1, 'C')
        self.ln(10)

    def footer(self):
        self.set_y(-15)
        self.set_font('Helvetica', 'I', 8)
        self.cell(0, 10, f'Page {self.page_no()}/{{nb}} | Confidential & Proprietary', 0, 0, 'C')

def generate_proposal(client_data):
    pdf = ProposalPDF()
    pdf.alias_nb_pages()
    pdf.add_page()
    
    # Title Page
    pdf.set_font('Helvetica', 'B', 24)
    pdf.ln(40)
    pdf.cell(0, 10, f"Security Assessment & Proposal", 0, 1, 'C')
    pdf.set_font('Helvetica', '', 16)
    pdf.cell(0, 10, f"Prepared for: {client_data['name']}", 0, 1, 'C')
    pdf.cell(0, 10, f"Date: {datetime.now().strftime('%B %d, %Y')}", 0, 1, 'C')
    pdf.ln(20)
    
    # Executive Summary
    pdf.add_page()
    pdf.set_font('Helvetica', 'B', 16)
    pdf.cell(0, 10, "1. Executive Summary", 0, 1)
    pdf.set_font('Helvetica', '', 12)
    pdf.multi_cell(0, 6, 
        f"On-Site Intelligence (OSI) aims to partner with {client_data['name']} to fortify your digital and physical infrastructure. "
        f"Based on our discussion regarding {client_data['industry']}, we understand your primary concerns are: {client_data['concern']}."
    )
    pdf.ln(5)
    
    # Findings / Needs
    pdf.set_font('Helvetica', 'B', 16)
    pdf.cell(0, 10, "2. Understanding Your Needs", 0, 1)
    pdf.set_font('Helvetica', '', 12)
    pdf.cell(0, 10, f"Employees: {client_data['employees']}", 0, 1)
    pdf.multi_cell(0, 6, f"Pain Points Identified:\n- {client_data['pain1']}\n- {client_data['pain2']}")
    pdf.ln(5)
    
    # Proposed Solution
    pdf.set_font('Helvetica', 'B', 16)
    pdf.cell(0, 10, "3. OSI Recommended Strategy", 0, 1)
    pdf.set_font('Helvetica', '', 12)
    
    services = []
    total_cost = 0
    if client_data['service_scout']: 
        services.append("OSI Scout (Penetration Testing)")
        total_cost += 2500
    if client_data['service_sentinel']: 
        services.append("OSI Sentinel (24/7 Network Monitoring)")
        total_cost += 1500
    if client_data['service_vision']: 
        services.append("OSI Vision (AI Surveillance)")
        total_cost += 5000
    if client_data['service_cortex']: 
        services.append("OSI Cortex (Private AI Knowledge Base)")
        total_cost += 8000
    if client_data['service_industry']: 
        services.append("OSI Industrial (Predictive Maintenance)")
        total_cost += 10000

    for s in services:
        pdf.cell(0, 8, f"- {s}", 0, 1)
        
    pdf.ln(5)
    pdf.set_font('Helvetica', 'B', 14)
    pdf.cell(0, 10, f"Estimated Investment: ${total_cost:,} (One-time Setup)", 0, 1)
    pdf.set_font('Helvetica', 'I', 10)
    pdf.cell(0, 10, "+ Monthly Maintenance (Optional): $500 - $2,000", 0, 1)
    
    # Next Steps
    pdf.ln(10)
    pdf.set_font('Helvetica', 'B', 16)
    pdf.cell(0, 10, "4. Next Steps", 0, 1)
    pdf.set_font('Helvetica', '', 12)
    pdf.multi_cell(0, 6, 
        "1. Approval of this preliminary proposal.\n"
        "2. Execute Non-Disclosure Agreement (NDA).\n"
        "3. Schedule On-Site Deep Dive Assessment.\n"
        "4. Deployment & Training."
    )

    filename = f"OSI_Proposal_{client_data['name'].replace(' ', '_')}.pdf"
    pdf.output(filename)
    return filename

def run_wizard():
    console.print(Panel("[bold green]OSI SALES CONSULTANT WIZARD[/bold green]", subtitle="Discovery Mode"))
    
    data = {}
    data['name'] = Prompt.ask("Client Company Name")
    data['industry'] = Prompt.ask("Industry")
    data['employees'] = IntPrompt.ask("Number of Employees")
    data['concern'] = Prompt.ask("Primary Security Concern")
    data['pain1'] = Prompt.ask("Top Pain Point #1")
    data['pain2'] = Prompt.ask("Top Pain Point #2")
    
    console.print("\n[bold cyan]Service Qualification:[/bold cyan]")
    data['service_scout'] = Prompt.ask("Concerned about Hackers/Breaches?", choices=["y", "n"]) == "y"
    data['service_sentinel'] = Prompt.ask("Needs 24/7 Network Watch?", choices=["y", "n"]) == "y"
    data['service_vision'] = Prompt.ask("Needs Camera AI/Physical Security?", choices=["y", "n"]) == "y"
    data['service_cortex'] = Prompt.ask("Needs Private Chat/Doc Search?", choices=["y", "n"]) == "y"
    data['service_industry'] = Prompt.ask("Has Heavy Machinery/Inventory?", choices=["y", "n"]) == "y"
    
    console.print("\n[yellow]Generating Proposal...[/yellow]")
    filename = generate_proposal(data)
    console.print(f"[bold green]Proposal Generated: {filename}[/bold green]")
    # Try to open it
    # os.system(f"xdg-open {filename}")

if __name__ == "__main__":
    run_wizard()
