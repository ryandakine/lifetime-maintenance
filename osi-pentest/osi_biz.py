import json
import os
from datetime import datetime

class PricingEngine:
    def __init__(self):
        self.base_rates = {
            "PenTest": {"Small": 2500, "Medium": 4000, "Large": 12000},
            "LLM": {"Small": 5000, "Cluster": 12000, "Mesh": 25000},
            "Vision": {"Small": 3500, "Medium": 7000, "Large": 12000},
            "Network": {"Small": 5000, "Medium": 10000, "Large": 18000},
            "Industrial": {"Small": 6000, "Medium": 12000, "Large": 20000},
            "Retainer": {"Tier1": 1000, "Tier2": 2500, "Tier3": 5000}
        }
        self.multipliers = {
            "Industry": {"Healthcare": 1.2, "Financial": 1.25, "Legal": 1.15, "Gov": 1.3, "Mfg": 1.0, "Tech": 1.1},
            "Complexity": {"Standard": 1.0, "High": 1.25, "Very High": 1.5},
            "Urgency": {"Standard": 1.0, "Expedited": 1.25, "Emergency": 2.0}
        }

    def calculate_price(self, service, size, industry, complexity, urgency):
        base = self.base_rates.get(service, {}).get(size, 0)
        mult_ind = self.multipliers["Industry"].get(industry, 1.0)
        mult_comp = self.multipliers["Complexity"].get(complexity, 1.0)
        mult_urg = self.multipliers["Urgency"].get(urgency, 1.0)
        
        final = base * mult_ind * mult_comp * mult_urg
        return final, {
            "Base": base,
            "Industry": f"x{mult_ind}",
            "Complexity": f"x{mult_comp}",
            "Urgency": f"x{mult_urg}"
        }
    
    def get_recommended_package(self, budget, industry):
        """Recommend best service package for budget"""
        recommendations = []
        for service, sizes in self.base_rates.items():
            for size, base_price in sizes.items():
                mult = self.multipliers["Industry"].get(industry, 1.0)
                final = base_price * mult
                if final <= budget:
                    recommendations.append({
                        "service": service,
                        "size": size,
                        "price": final,
                        "fit_score": (final / budget) * 100
                    })
        return sorted(recommendations, key=lambda x: x['fit_score'], reverse=True)

class CompetitorDatabase:
    def __init__(self, db_file="competitors.json"):
        self.db_file = db_file
        self.data = self._load()

    def _load(self):
        if not os.path.exists(self.db_file):
            # Seed with some default competitors
            return [
                {
                    "name": "Big Name MSSP",
                    "strengths": ["Brand recognition", "Large team", "24/7 SOC"],
                    "weaknesses": ["Expensive", "Slow response", "Cookie-cutter solutions"],
                    "pricing": "$10k-50k/month retainers",
                    "win_strategy": "Emphasize personalized service, faster response, AI-powered tools"
                },
                {
                    "name": "Local IT Shop",
                    "strengths": ["Cheap", "Local presence"],
                    "weaknesses": ["No specialized security expertise", "Limited tools"],
                    "pricing": "$500-2k/month",
                    "win_strategy": "Show certifications, advanced tooling, proven methodology"
                }
            ]
        try:
            with open(self.db_file, 'r') as f: return json.load(f)
        except: return []

    def save(self):
        with open(self.db_file, 'w') as f: json.dump(self.data, f, indent=4)

    def add_competitor(self, name, strengths, weaknesses, pricing, win_strategy=""):
        self.data.append({
            "name": name,
            "strengths": strengths,
            "weaknesses": weaknesses,
            "pricing": pricing,
            "win_strategy": win_strategy
        })
        self.save()

    def get_battle_card(self, name):
        return next((c for c in self.data if c['name'] == name), None)
    
    def get_all(self):
        return self.data

class ProposalGenerator:
    """Generate custom proposals using templates and client data"""
    
    def __init__(self):
        self.templates = {
            "PenTest": {
                "intro": "Thank you for the opportunity to propose a comprehensive penetration testing engagement for {client_name}.",
                "approach": "Our methodology follows industry standards (PTES, OWASP) with advanced AI-powered reconnaissance.",
                "deliverables": ["Executive Summary", "Detailed Technical Report", "Remediation Roadmap", "Re-test (30 days)"],
                "timeline": "2-4 weeks depending on scope"
            },
            "Retainer": {
                "intro": "We're excited to partner with {client_name} as your ongoing security partner.",
                "approach": "Monthly security monitoring, quarterly assessments, and on-demand incident response.",
                "deliverables": ["Monthly Security Reports", "Quarterly Vulnerability Scans", "24/7 On-Call Support"],
                "timeline": "Ongoing monthly partnership"
            }
        }
    
    def generate(self, client_name, service_type, custom_scope="", timeline="", investment=0):
        template = self.templates.get(service_type, self.templates["PenTest"])
        
        proposal = {
            "client": client_name,
            "date": datetime.now().strftime("%B %d, %Y"),
            "intro": template["intro"].format(client_name=client_name),
            "approach": template["approach"],
            "scope": custom_scope if custom_scope else "To be defined in discovery call",
            "deliverables": template["deliverables"],
            "timeline": timeline if timeline else template["timeline"],
            "investment": f"${investment:,.2f}",
            "valid_until": "30 days from proposal date"
        }
        return proposal

class CaseStudyBuilder:
    """Build case studies from successful client engagements"""
    
    def __init__(self, db_file="case_studies.json"):
        self.db_file = db_file
        self.studies = self._load()
    
    def _load(self):
        if not os.path.exists(self.db_file):
            return []
        try:
            with open(self.db_file, 'r') as f: return json.load(f)
        except: return []
    
    def save(self):
        with open(self.db_file, 'w') as f: json.dump(self.studies, f, indent=4)
    
    def create_study(self, client_industry, challenge, solution, results, metrics):
        """Create a new case study"""
        study = {
            "id": len(self.studies) + 1,
            "industry": client_industry,
            "challenge": challenge,
            "solution": solution,
            "results": results,
            "metrics": metrics,  # e.g., {"vulnerabilities_found": 47, "risk_reduction": "85%"}
            "created_date": datetime.now().isoformat()
        }
        self.studies.append(study)
        self.save()
        return study
    
    def get_by_industry(self, industry):
        return [s for s in self.studies if s['industry'] == industry]
    
    def get_all(self):
        return self.studies
